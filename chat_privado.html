<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RANTIKUY EMPIRE OS v22 - ULTRA TIT√ÅN</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            /* Paleta Huanta - Colores vibrantes y claros seg√∫n instrucci√≥n */
            --p-green: #10b981;
            --p-vibrant: #22c55e;
            --p-gold: #f59e0b;
            --p-sky: #0ea5e9;
            --p-light: #f8fafc;
            --p-white: #ffffff;
            --p-dark: #0f172a;
            --p-slate: #64748b;
            --p-red: #ef4444;
            --p-soft-green: #ecfdf5;
            --p-soft-gold: #fffbeb;
            --p-soft-red: #fef2f2;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* --- BASE & ESTRUCTURA --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.25s ease; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: var(--p-light); overflow: hidden; color: var(--p-dark); }
        
        /* Sistema de Navegaci√≥n Lateral */
        .app-shell { display: flex; width: 500%; height: 100%; transition: transform 0.6s cubic-bezier(0.85, 0, 0.15, 1); }
        .pos-1 { transform: translateX(0%); }
        .pos-2 { transform: translateX(-20%); }
        .pos-3 { transform: translateX(-40%); }
        .pos-4 { transform: translateX(-60%); }
        .pos-5 { transform: translateX(-80%); }

        .screen { width: 20%; height: 100%; display: flex; flex-direction: column; background: var(--p-white); overflow: hidden; position: relative; }

        /* --- CABECERAS --- */
        .header-premium { 
            padding: 20px 25px; background: white; border-bottom: 2px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .header-premium h1 { margin: 0; font-size: 22px; font-weight: 800; letter-spacing: -1px; cursor: pointer; }
        .header-premium h1 span { color: var(--p-green); }
        .live-status { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 900; color: var(--p-green); text-transform: uppercase; background: var(--p-soft-green); padding: 5px 12px; border-radius: 20px; }
        .dot { width: 8px; height: 8px; background: var(--p-green); border-radius: 50%; animation: blink 1.5s infinite; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }

        /* --- CHAT (PANTALLA PRINCIPAL) --- */
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; background: #f0f2f5; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 85%; padding: 14px 18px; border-radius: 22px; font-size: 14px; position: relative; line-height: 1.5; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .b-me { align-self: flex-end; background: var(--p-green); color: white; border-bottom-right-radius: 4px; }
        .b-them { align-self: flex-start; background: white; color: var(--p-dark); border-bottom-left-radius: 4px; border: 1px solid #e2e8f0; }
        .b-user { font-size: 10px; font-weight: 800; display: block; margin-bottom: 4px; text-transform: uppercase; opacity: 0.8; }
        .b-info { font-size: 9px; margin-top: 6px; display: flex; justify-content: flex-end; gap: 4px; opacity: 0.7; }

        .chat-input-bar { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; padding-bottom: calc(20px + var(--safe-bottom)); }
        .chat-field { flex: 1; background: #f1f5f9; border: none; padding: 15px 20px; border-radius: 30px; font-size: 15px; outline: none; }
        .btn-send { background: var(--p-green); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }

        /* --- DASHBOARD & VENTAS --- */
        .scroll-area { flex: 1; overflow-y: auto; padding: 20px; background: #fafbfc; padding-bottom: 120px; }
        .empire-card { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 30px; border-radius: 35px; margin-bottom: 25px; box-shadow: 0 15px 30px rgba(15,23,42,0.15); }
        .stat-label { font-size: 11px; font-weight: 800; opacity: 0.6; text-transform: uppercase; letter-spacing: 1.5px; }
        .stat-value { font-size: 42px; font-weight: 800; margin: 8px 0; letter-spacing: -2px; }

        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-box { background: rgba(255,255,255,0.07); padding: 15px; border-radius: 22px; border: 1px solid rgba(255,255,255,0.1); }
        .stat-box b { font-size: 18px; display: block; margin-top: 5px; }

        /* --- PRODUCTOS --- */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 5px; }
        .item-card { background: white; border-radius: 28px; padding: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid #f1f5f9; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .item-img { width: 65px; height: 65px; border-radius: 20px; background: var(--p-soft-green); object-fit: cover; border: 1px solid #eee; }
        .item-details { flex: 1; }
        .item-details b { font-size: 16px; color: var(--p-dark); display: block; margin-bottom: 4px; }
        .item-details span { color: var(--p-green); font-weight: 800; font-size: 14px; }

        .btn-action { border: none; padding: 10px 14px; border-radius: 14px; font-size: 11px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        .btn-sell { background: var(--p-soft-green); color: var(--p-green); }
        .btn-debt { background: var(--p-soft-gold); color: var(--p-gold); }

        /* --- BOTONES FLOTANTES --- */
        .fab { position: absolute; bottom: 100px; right: 20px; width: 60px; height: 60px; background: var(--p-dark); color: white; border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 500; cursor: pointer; }

        /* --- DOCK --- */
        .dock { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); padding: 12px; display: flex; justify-content: space-around; border-top: 1px solid #f1f5f9; padding-bottom: calc(15px + var(--safe-bottom)); z-index: 1000; }
        .dock-item { border: none; background: none; font-size: 24px; color: #cbd5e1; width: 55px; height: 55px; border-radius: 20px; cursor: pointer; position: relative; transition: 0.3s; }
        .dock-item.active { color: var(--p-green); background: var(--p-soft-green); transform: translateY(-5px); }
        .dock-item::after { content: attr(data-label); position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); font-size: 8px; font-weight: 800; color: inherit; }

        /* --- MODALES --- */
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: flex-end; }
        .modal { background: white; width: 100%; border-radius: 40px 40px 0 0; padding: 35px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .f-label { font-size: 11px; font-weight: 900; color: var(--p-slate); text-transform: uppercase; margin-bottom: 8px; display: block; margin-left: 5px; }
        .f-input { width: 100%; padding: 18px; border-radius: 18px; border: 2px solid #f1f5f9; font-size: 16px; margin-bottom: 20px; outline: none; background: #f8fafc; }
        .f-input:focus { border-color: var(--p-green); background: white; }
        .f-btn-main { width: 100%; padding: 20px; border-radius: 20px; border: none; background: var(--p-green); color: white; font-weight: 800; font-size: 17px; cursor: pointer; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2); }

        /* --- RECIBO --- */
        .receipt-ui { background: white; padding: 25px; border: 2px dashed #ddd; font-family: 'Courier New', monospace; color: #111; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="app-shell" id="appShell">
    
    <div class="screen">
        <header class="header-premium">
            <h1 onclick="handleAdminTaps()">Empire<span>.Chat</span></h1>
            <div class="live-status"><div class="dot"></div> En L√≠nea</div>
        </header>

        <div class="chat-container" id="chat-flow">
            </div>

        <div class="fab" onclick="ui_showCommandCenter()">‚ö°</div>

        <div class="chat-input-bar">
            <input type="text" id="chat-msg" class="chat-field" placeholder="Orden de mando..." onkeypress="if(event.key==='Enter') logic_sendMessage()">
            <button class="btn-send" onclick="logic_sendMessage()">üöÄ</button>
        </div>
    </div>

    <div class="screen">
        <header class="header-premium">
            <h1>Master<span>.Stock</span></h1>
        </header>
        <div class="scroll-area">
            <div class="empire-card">
                <div class="stat-label">Liquidez Real (Caja)</div>
                <div class="stat-value" id="caja-total">S/ 0.00</div>
                <div class="grid-stats">
                    <div class="stat-box">
                        <span class="stat-label">Fiados</span>
                        <b id="deuda-total" style="color:var(--p-gold);">S/ 0.00</b>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Gastos</span>
                        <b id="gasto-total" style="color:var(--p-red);">S/ 0.00</b>
                    </div>
                </div>
            </div>

            <div class="section-header">
                <b style="font-size: 20px;">Almac√©n Huanta</b>
                <button class="btn-action" style="background:var(--p-dark); color:white;" onclick="ui_modalAddStock()">+ Stock</button>
            </div>

            <input type="text" id="search-bar" class="f-input" placeholder="üîç Buscar en imperio..." oninput="renderStock()">

            <div id="stock-list">
                </div>
        </div>
    </div>

    <div class="screen">
        <header class="header-premium"><h1>Ruta<span>.Logistics</span></h1></header>
        <div class="scroll-area" id="logistics-list">
            </div>
        <div style="padding:20px; position:fixed; bottom:80px; width:20%;">
            <button class="f-btn-main" onclick="ui_modalAddRoute()">PROGRAMAR DESPACHO</button>
        </div>
    </div>

    <div class="screen">
        <header class="header-premium"><h1>Data<span>.Center</span></h1></header>
        <div class="scroll-area">
            <div class="empire-card" style="background:white; border:1px solid #eee; color:var(--p-dark);">
                <div class="stat-label" style="color:var(--p-slate);">Rendimiento Total</div>
                <div class="stat-value" id="utilidad-neta" style="color:var(--p-green);">S/ 0.00</div>
                <div style="height:5px; background:#f1f5f9; border-radius:10px; margin-top:15px; overflow:hidden;">
                    <div id="progress-bar" style="height:100%; background:var(--p-green); width:0%;"></div>
                </div>
            </div>
            <div class="section-header"><b>Log de Auditor√≠a</b></div>
            <div id="audit-log"></div>
        </div>
    </div>

    <div class="screen">
        <header class="header-premium"><h1>System<span>.Config</span></h1></header>
        <div class="scroll-area">
            <div style="padding:30px; background:var(--p-dark); color:white; border-radius:30px; margin-bottom:20px;">
                <b style="font-size:22px;">Rantikuy Tit√°n</b><br>
                <span>Versi√≥n: 22.1.0 Stable</span><br>
                <small style="opacity:0.5;">Huanta - Nodo Central</small>
            </div>
            <button class="f-input" style="text-align:left; background:white;" onclick="logic_exportDB()">üìÇ Exportar Backup (JSON)</button>
            <button class="f-input" style="text-align:left; background:var(--p-soft-red); color:var(--p-red); border-color:var(--p-soft-red);" onclick="logic_resetSystem()">‚ö†Ô∏è Formatear Todo</button>
        </div>
    </div>

</div>

<nav class="dock">
    <button class="dock-item active" onclick="navTo(1)" data-label="Comando">üè¢</button>
    <button class="dock-item" onclick="navTo(2)" data-label="Almac√©n">üõçÔ∏è</button>
    <button class="dock-item" onclick="navTo(3)" data-label="Rutas">üöõ</button>
    <button class="dock-item" onclick="navTo(4)" data-label="Data">üìä</button>
    <button class="dock-item" onclick="navTo(5)" data-label="Ajustes">‚öôÔ∏è</button>
</nav>

<div class="overlay" id="overlay" onclick="if(event.target==this) closeModal()">
    <div class="modal" id="modal-content"></div>
</div>

<script>
    // --- N√öCLEO DE DATOS INTELIGENTE ---
    const APP_KEY = 'rantikuy_ultra_v22';
    let db = JSON.parse(localStorage.getItem(APP_KEY)) || {
        caja: 0,
        inventario: [],
        deudas: [],
        gastos: [],
        auditoria: [],
        rutas: [],
        mensajes: [
            { u: 'Sistema', t: 'Sincronizaci√≥n completa. Bienvenido, L√≠der.', h: '08:00', me: false }
        ]
    };

    function save() {
        localStorage.setItem(APP_KEY, JSON.stringify(db));
        refreshUI();
    }

    // --- NAVEGACI√ìN ---
    function navTo(p) {
        document.getElementById('appShell').className = 'app-shell pos-' + p;
        const items = document.querySelectorAll('.dock-item');
        items.forEach((btn, idx) => btn.classList.toggle('active', (idx + 1) === p));
    }

    // --- L√ìGICA DE COMUNICACI√ìN ---
    function logic_sendMessage() {
        const input = document.getElementById('chat-msg');
        if (!input.value.trim()) return;

        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const text = input.value;
        
        db.mensajes.push({ u: 'L√≠der', t: text, h: time, me: true });
        input.value = '';
        
        // Simular respuesta de sistema para el video
        if(text.toLowerCase().includes('reporte')) {
            setTimeout(() => {
                db.mensajes.push({ u: 'Sistema', t: `Reporte actual: Caja S/ ${db.caja.toFixed(2)}. Todo en orden.`, h: 'Ahora', me: false });
                save();
            }, 1000);
        }

        save();
        const flow = document.getElementById('chat-flow');
        flow.scrollTop = flow.scrollHeight;
    }

    function renderChats() {
        const flow = document.getElementById('chat-flow');
        flow.innerHTML = db.mensajes.map(m => `
            <div class="bubble ${m.me ? 'b-me' : 'b-them'}">
                <span class="b-user">${m.u}</span>
                ${m.t}
                <div class="b-info">${m.h} ${m.me ? '‚úì‚úì' : ''}</div>
            </div>
        `).join('');
    }

    // --- L√ìGICA DE NEGOCIO (VENTAS) ---
    function renderStock() {
        const list = document.getElementById('stock-list');
        const search = document.getElementById('search-bar').value.toLowerCase();
        const filtered = db.inventario.filter(i => i.nombre.toLowerCase().includes(search));

        list.innerHTML = filtered.map(item => `
            <div class="item-card">
                <img src="${item.img || 'https://via.placeholder.com/100?text=üì¶'}" class="item-img">
                <div class="item-details">
                    <b>${item.nombre}</b>
                    <span>S/ ${item.precio.toFixed(2)}</span>
                </div>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <button class="btn-action btn-sell" onclick="logic_executeSale(${item.id}, false)">Venta</button>
                    <button class="btn-action btn-debt" onclick="logic_executeSale(${item.id}, true)">Fiado</button>
                </div>
            </div>
        `).join('') || '<p style="text-align:center; padding:40px; color:gray;">No hay stock registrado.</p>';
    }

    function logic_executeSale(id, isDebt) {
        const idx = db.inventario.findIndex(x => x.id === id);
        const item = db.inventario[idx];

        if (isDebt) {
            const cliente = prompt("Nombre del deudor:");
            if (!cliente) return;
            db.deudas.push({ id: Date.now(), cliente, monto: item.precio, item: item.nombre, fecha: new Date().toLocaleDateString() });
            db.mensajes.push({ u: 'Sistema', t: `üì¢ FIADO REGISTRADO: ${cliente} debe S/ ${item.precio} por ${item.item}`, h: 'Ahora', me: false });
        } else {
            db.caja += item.precio;
            db.auditoria.push({ t: `Venta: ${item.nombre}`, v: item.precio, type: 'plus' });
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.7 } });
            ui_showReceipt(item);
        }

        db.inventario.splice(idx, 1);
        save();
    }

    // --- MODALES & FORMS ---
    function ui_showCommandCenter() {
        showModal(`
            <h2 style="margin:0 0 20px 0;">Centro de Comando</h2>
            <div class="grid-stats" style="margin-bottom:20px;">
                <button class="stat-box" style="background:var(--p-soft-green); border:none;" onclick="navTo(2); closeModal();">
                    <span style="font-size:24px;">üì¶</span><br><b style="color:var(--p-green);">Vender</b>
                </button>
                <button class="stat-box" style="background:var(--p-soft-red); border:none;" onclick="ui_modalAddGasto()">
                    <span style="font-size:24px;">üí∏</span><br><b style="color:var(--p-red);">Gasto</b>
                </button>
            </div>
            <button class="f-btn-main" style="background:var(--p-dark);" onclick="ui_showDeudas()">VER CUENTAS POR COBRAR</button>
        `);
    }

    function ui_modalAddStock() {
        showModal(`
            <h2>Nuevo Stock</h2>
            <label class="f-label">Producto</label>
            <input type="text" id="p-name" class="f-input" placeholder="Ej. Abono Tit√°n 50kg">
            <label class="f-label">Precio de Venta</label>
            <input type="number" id="p-price" class="f-input" placeholder="0.00">
            <label class="f-label">Imagen (Opcional)</label>
            <input type="file" id="p-img" class="f-input" accept="image/*">
            <button class="f-btn-main" onclick="logic_addStock()">GUARDAR EN IMPERIO</button>
        `);
    }

    function logic_addStock() {
        const n = document.getElementById('p-name').value;
        const p = parseFloat(document.getElementById('p-price').value);
        const imgFile = document.getElementById('p-img').files[0];

        if (!n || isNaN(p)) return;

        const reader = new FileReader();
        reader.onloadend = () => {
            db.inventario.push({ id: Date.now(), nombre: n, precio: p, img: reader.result });
            db.mensajes.push({ u: 'Sistema', t: `üì¶ STOCK: Se ha a√±adido ${n} al inventario.`, h: 'Ahora', me: false });
            save(); closeModal();
        };

        if(imgFile) reader.readAsDataURL(imgFile);
        else {
            db.inventario.push({ id: Date.now(), nombre: n, precio: p, img: null });
            db.mensajes.push({ u: 'Sistema', t: `üì¶ STOCK: Se ha a√±adido ${n} al inventario.`, h: 'Ahora', me: false });
            save(); closeModal();
        }
    }

    function ui_modalAddGasto() {
        showModal(`
            <h2>Registrar Salida</h2>
            <input type="text" id="g-desc" class="f-input" placeholder="¬øEn qu√© se gast√≥?">
            <input type="number" id="g-val" class="f-input" placeholder="Monto S/">
            <button class="f-btn-main" style="background:var(--p-red);" onclick="logic_addGasto()">RESTAR DE CAJA</button>
        `);
    }

    function logic_addGasto() {
        const d = document.getElementById('g-desc').value;
        const v = parseFloat(document.getElementById('g-val').value);
        if(!d || isNaN(v)) return;

        db.caja -= v;
        db.gastos.push({ desc: d, monto: v });
        db.auditoria.push({ t: `Gasto: ${d}`, v: v, type: 'minus' });
        save(); closeModal();
    }

    function ui_showDeudas() {
        const items = db.deudas.map((d, i) => `
            <div class="item-card" style="border-left:5px solid var(--p-gold);">
                <div class="item-details">
                    <b>üë§ ${d.cliente}</b>
                    <small>${d.item} - ${d.fecha}</small><br>
                    <span style="color:var(--p-gold);">Debe: S/ ${d.monto.toFixed(2)}</span>
                </div>
                <button class="btn-action btn-sell" onclick="logic_collectDebt(${i})">COBRAR</button>
            </div>
        `).join('') || 'No hay deudas pendientes.';
        showModal(`<h2>Cuentas por Cobrar</h2>${items}<button class="f-btn-main" style="margin-top:20px;" onclick="closeModal()">VOLVER</button>`);
    }

    function logic_collectDebt(i) {
        const d = db.deudas[i];
        db.caja += d.monto;
        db.auditoria.push({ t: `Cobro: ${d.cliente}`, v: d.monto, type: 'plus' });
        db.mensajes.push({ u: 'Sistema', t: `‚úÖ COBRO: ${d.cliente} ha pagado S/ ${d.monto}`, h: 'Ahora', me: false });
        db.deudas.splice(i, 1);
        save(); closeModal();
    }

    function ui_showReceipt(item) {
        showModal(`
            <div class="receipt-ui">
                <center>
                    <b style="font-size:18px;">RANTIKUY EMPIRE</b><br>
                    HUANTA - PERU<br>
                    ----------------------------<br>
                    TICKET DE VENTA OFICIAL<br>
                </center>
                <br>
                FECHA: ${new Date().toLocaleString()}<br>
                ITEM: ${item.nombre}<br>
                TOTAL: S/ ${item.precio.toFixed(2)}<br>
                ESTADO: PAGADO<br>
                ----------------------------<br>
                <center>¬°EL IMPERIO CRECE!</center>
            </div>
            <button class="f-btn-main" onclick="closeModal()">LISTO</button>
        `);
    }

    // --- LOG√çSTICA ---
    function ui_modalAddRoute() {
        showModal(`
            <h2>Nueva Ruta</h2>
            <input type="text" id="r-dest" class="f-input" placeholder="Destino (Lugar/Cliente)">
            <input type="text" id="r-obs" class="f-input" placeholder="Obs: Ej. Cami√≥n rojo">
            <button class="f-btn-main" onclick="logic_addRoute()">GUARDAR RUTA</button>
        `);
    }

    function logic_addRoute() {
        const d = document.getElementById('r-dest').value;
        const o = document.getElementById('r-obs').value;
        if(!d) return;
        db.rutas.push({ dest: d, obs: o, status: 'Pendiente' });
        save(); closeModal();
    }

    // --- RENDERIZADO GENERAL ---
    function refreshUI() {
        // Caja y Dashboard
        document.getElementById('caja-total').innerText = 'S/ ' + db.caja.toFixed(2);
        document.getElementById('deuda-total').innerText = 'S/ ' + db.deudas.reduce((a, b) => a + b.monto, 0).toFixed(2);
        document.getElementById('gasto-total').innerText = 'S/ ' + db.gastos.reduce((a, b) => a + b.monto, 0).toFixed(2);
        document.getElementById('utilidad-neta').innerText = 'S/ ' + db.caja.toFixed(2);

        // Barra progreso (Ej: Meta 10,000)
        const percent = Math.min((db.caja / 10000) * 100, 100);
        document.getElementById('progress-bar').style.width = percent + '%';

        renderChats();
        renderStock();
        renderAudit();
        renderLogistics();
    }

    function renderAudit() {
        const log = document.getElementById('audit-log');
        log.innerHTML = db.auditoria.slice().reverse().map(a => `
            <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:14px;">${a.t}</span>
                <b style="color:${a.type==='plus'?'var(--p-green)':'var(--p-red)'}">${a.type==='plus'?'+':'-'} S/ ${a.v.toFixed(2)}</b>
            </div>
        `).join('');
    }

    function renderLogistics() {
        const list = document.getElementById('logistics-list');
        list.innerHTML = db.rutas.map((r, i) => `
            <div class="item-card" style="border-left:6px solid var(--p-gold);">
                <div class="item-details">
                    <b>üìç ${r.dest}</b>
                    <small>${r.obs}</small>
                </div>
                <button class="btn-action" style="background:var(--p-soft-red); color:red;" onclick="db.rutas.splice(${i},1); save();">X</button>
            </div>
        `).join('') || '<p style="text-align:center; padding:40px;">No hay despachos programados.</p>';
    }

    // --- UTILIDADES ---
    function showModal(html) {
        document.getElementById('modal-content').innerHTML = html;
        document.getElementById('overlay').style.display = 'flex';
    }
    function closeModal() { document.getElementById('overlay').style.display = 'none'; }

    function handleAdminTaps() {
        if(!window.taps) window.taps = 0;
        window.taps++;
        if(window.taps >= 7) {
            alert("ADMIN: Exportando consola...");
            console.log(db);
            window.taps = 0;
        }
        setTimeout(() => window.taps = 0, 3000);
    }

    function logic_exportDB() {
        const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `rantikuy_backup_${Date.now()}.json`;
        a.click();
    }

    function logic_resetSystem() {
        if(confirm("¬øEST√ÅS SEGURO? Se borrar√° todo el imperio.")) {
            localStorage.clear();
            location.reload();
        }
    }

    // Iniciar
    window.onload = () => {
        refreshUI();
        const flow = document.getElementById('chat-flow');
        flow.scrollTop = flow.scrollHeight;
    };
</script>
</body>
</html>
