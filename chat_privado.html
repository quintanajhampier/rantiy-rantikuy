<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>R&R - Chat Elite</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --verde: #22c55e;
            --verde-brillante: #4ade80;
            --fondo: #f1f5f9;
            --oscuro: #0f172a;
            --blanco: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--fondo); overflow: hidden;
        }

        /* --- CONTENEDOR MAESTRO --- */
        .app-shell {
            display: flex; flex-direction: column;
            height: 100vh; height: -webkit-fill-available; /* Fix para iOS */
        }

        /* --- HEADER GLASS --- */
        .p-header { 
            padding: 15px; background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 100;
        }

        .back-btn { width: 38px; height: 38px; border-radius: 12px; border: none; background: #f1f5f9; color: var(--oscuro); font-size: 18px; cursor: pointer; }
        
        .avatar { width: 42px; height: 42px; border-radius: 14px; background: linear-gradient(135deg, var(--verde), #15803d); display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 18px; box-shadow: 0 4px 10px rgba(34,197,94,0.3); }

        .name-meta { flex: 1; }
        .name-meta b { display: block; font-size: 15px; color: var(--oscuro); letter-spacing: -0.3px; }
        .name-meta span { font-size: 10px; color: var(--verde); font-weight: 800; display: flex; align-items: center; gap: 4px; }
        .name-meta span::before { content: ''; width: 6px; height: 6px; background: var(--verde); border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }

        /* --- ZONA DE CHAT --- */
        .msg-area { 
            flex: 1; padding: 20px 15px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 12px;
            background: url('https://www.transparenttextures.com/patterns/cubes.png'); /* Sutil textura */
        }
        
        .bubble { 
            max-width: 80%; padding: 12px 16px; border-radius: 22px; font-size: 14.5px; font-weight: 600; 
            line-height: 1.4; position: relative; transition: 0.2s;
        }

        .bubble-out { 
            align-self: flex-end; background: var(--verde); color: white; 
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(34,197,94,0.2);
        }

        .bubble-in { 
            align-self: flex-start; background: var(--blanco); color: var(--oscuro); 
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }

        .bubble img { width: 100%; border-radius: 15px; margin-top: 5px; }

        .time { font-size: 9px; opacity: 0.6; display: block; margin-top: 5px; text-align: right; font-weight: 400; }

        /* --- DOCK DE HERRAMIENTAS MODERNO --- */
        .imperial-tools { 
            display: flex; gap: 8px; padding: 0 15px 10px; background: transparent; overflow-x: auto; scrollbar-width: none;
        }
        .tool-chip { padding: 8px 15px; background: white; border-radius: 20px; border: 1px solid #e2e8f0; font-size: 11px; font-weight: 800; color: var(--gris); white-space: nowrap; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* --- INPUT FINAL --- */
        .input-wrapper { 
            background: white; padding: 10px 15px 30px; 
            border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px;
        }

        .input-group { flex: 1; position: relative; display: flex; align-items: center; }
        
        .main-input { 
            width: 100%; padding: 14px 45px 14px 20px; background: #f1f5f9; 
            border: 2px solid transparent; border-radius: 25px; font-weight: 600; outline: none; transition: 0.3s;
        }

        .main-input:focus { background: white; border-color: var(--verde); box-shadow: 0 0 15px rgba(34,197,94,0.1); }

        .cam-btn { position: absolute; right: 15px; background: none; border: none; font-size: 18px; cursor: pointer; color: var(--verde); }
        
        .send-btn { 
            width: 50px; height: 50px; border-radius: 50%; border: none; 
            background: var(--oscuro); color: white; display: flex; 
            align-items: center; justify-content: center; font-size: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.3s;
        }
        .send-btn:active { transform: scale(0.9) rotate(-15deg); background: var(--verde); }
    </style>
</head>
<body>

<div class="app-shell">
    <header class="p-header">
        <button class="back-btn" onclick="location.href='index.html'">‚ùÆ</button>
        <div class="avatar" id="partner-initial">?</div>
        <div class="name-meta">
            <b id="partner-name">...</b>
            <span>Activo en el Imperio</span>
        </div>
        <button onclick="wipe()" style="border:none; background:none; font-size:20px;">üßπ</button>
    </header>

    <div class="msg-area" id="chat-box">
        </div>

    <div class="imperial-tools">
        <div class="tool-chip" onclick="quickMsg('¬øEst√° disponible?')">üì¶ Disponibilidad</div>
        <div class="tool-chip" onclick="quickMsg('¬øPrecio m√≠nimo amigo?')">üí∞ Ofertar</div>
        <div class="tool-chip" onclick="shareLocation()">üìç Mi ubicaci√≥n</div>
        <div class="tool-chip" onclick="quickMsg('¬øD√≥nde nos encontramos?')">ü§ù Punto de encuentro</div>
    </div>

    <div class="input-wrapper">
        <div class="input-group">
            <input type="text" id="msg-input" class="main-input" placeholder="Escribe al comerciante..." autocomplete="off">
            <button class="cam-btn" onclick="triggerFile()">üì∑</button>
        </div>
        <button class="send-btn" onclick="processSend()">üöÄ</button>
    </div>
</div>

<script>
    const user = localStorage.getItem('rantiy_user') || "Yo";
    const partner = localStorage.getItem('current_chat_partner') || "Comerciante";
    const box = document.getElementById('chat-box');

    function init() {
        document.getElementById('partner-name').innerText = partner;
        document.getElementById('partner-initial').innerText = partner.charAt(0).toUpperCase();
        load();
        setInterval(load, 2000);
        
        document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') processSend(); };
    }

    function load() {
        const chats = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
        const key = [user, partner].sort().join('_');
        const msgs = chats[key] || [];
        
        const currentHTML = msgs.map(m => `
            <div class="bubble ${m.u === user ? 'bubble-out' : 'bubble-in'}">
                ${m.type === 'img' ? `<img src="${m.t}">` : m.t}
                <span class="time">${m.h}</span>
            </div>
        `).join('');

        if (box.innerHTML !== currentHTML) {
            box.innerHTML = currentHTML;
            box.scrollTop = box.scrollHeight;
        }
    }

    function processSend() {
        const input = document.getElementById('msg-input');
        if(!input.value.trim()) return;
        saveMsg(input.value, 'text');
        input.value = "";
    }

    function saveMsg(txt, type) {
        let data = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
        const key = [user, partner].sort().join('_');
        if(!data[key]) data[key] = [];
        
        data[key].push({
            u: user, 
            t: txt, 
            type: type, 
            h: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
        });
        
        localStorage.setItem('empire_private_chats', JSON.stringify(data));
        load();
    }

    function quickMsg(t) { saveMsg(t, 'text'); }

    function triggerFile() {
        let i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = e => {
            let r = new FileReader();
            r.onload = ev => saveMsg(ev.target.result, 'img');
            r.readAsDataURL(e.target.files[0]);
        };
        i.click();
    }

    function shareLocation() {
        navigator.geolocation.getCurrentPosition(p => {
            const map = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
            saveMsg(`<a href="${map}" target="_blank" style="color:inherit">üìç Mi Ubicaci√≥n actual</a>`, 'text');
        });
    }

    function wipe() {
        if(confirm("¬øLimpiar historial?")) {
            let data = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
            data[[user, partner].sort().join('_')] = [];
            localStorage.setItem('empire_private_chats', JSON.stringify(data));
            load();
        }
    }

    window.onload = init;
</script>
</body>
</html>
