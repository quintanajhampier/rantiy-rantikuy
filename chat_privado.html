<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>R&R Business Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --verde-wa: #128c7e;
            --verde-imperio: #22c55e;
            --verde-light: #dcfce7;
            --fondo-wa: #efeae2; /* Color cl√°sico fondo WhatsApp */
            --oscuro: #1e293b;
            --blanco: #ffffff;
            --gris-texto: #64748b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--blanco); overflow: hidden;
        }

        /* --- NAVEGACI√ìN PRINCIPAL --- */
        .view-container {
            display: flex; width: 200%; height: 100vh;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .view-active-chat { transform: translateX(-50%); }

        .screen { width: 50%; height: 100%; display: flex; flex-direction: column; background: var(--blanco); }

        /* --- PANTALLA 1: LISTA DE CHATS --- */
        .list-header {
            padding: 20px 15px; background: var(--blanco);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f1f5f9;
        }

        .list-header h1 { font-size: 24px; font-weight: 800; margin: 0; color: var(--verde-imperio); }

        .chat-list { flex: 1; overflow-y: auto; padding-bottom: 80px; }

        .chat-item {
            display: flex; align-items: center; padding: 15px;
            gap: 15px; cursor: pointer; transition: 0.2s;
            border-bottom: 1px solid #f8fafc;
        }
        .chat-item:active { background: #f1f5f9; }

        .avatar-lg { 
            width: 55px; height: 55px; border-radius: 20px; 
            background: linear-gradient(135deg, var(--verde-imperio), #15803d);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 800; font-size: 22px;
        }

        .chat-meta { flex: 1; border-bottom: 0.5px solid #eee; padding-bottom: 10px; }
        .chat-meta div { display: flex; justify-content: space-between; align-items: center; }
        .chat-meta b { font-size: 16px; color: var(--oscuro); }
        .chat-meta span { font-size: 11px; color: var(--gris-texto); }
        .chat-meta p { margin: 5px 0 0; font-size: 13px; color: var(--gris-texto); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

        /* --- PANTALLA 2: CHAT INTERNO --- */
        .chat-screen { background: var(--fondo-wa); position: relative; }
        
        .chat-header {
            padding: 10px 15px; background: var(--blanco);
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10;
        }

        .back-area { display: flex; align-items: center; cursor: pointer; gap: 5px; }

        .msg-area { 
            flex: 1; padding: 15px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 8px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: 400px;
        }
        
        /* BUBBLES ESTILO WA BUSINESS */
        .bubble { 
            max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 14.5px; 
            position: relative; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .bubble-out { 
            align-self: flex-end; background: #e7ffdb; color: #303030; 
            border-top-right-radius: 0;
        }

        .bubble-in { 
            align-self: flex-start; background: var(--blanco); color: #303030; 
            border-top-left-radius: 0;
        }

        .bubble img { width: 100%; border-radius: 8px; margin-top: 5px; }

        .time { font-size: 10px; color: #888; text-align: right; margin-top: 4px; display: block; }

        /* TOOLS & INPUT */
        .quick-bar { display: flex; gap: 8px; padding: 10px; overflow-x: auto; scrollbar-width: none; }
        .q-chip { 
            padding: 8px 16px; background: var(--blanco); border-radius: 20px; 
            font-size: 12px; font-weight: 700; color: var(--verde-wa); 
            border: 1px solid var(--verde-light); white-space: nowrap;
        }

        .input-box { 
            padding: 10px 15px 25px; background: #f0f0f0; 
            display: flex; align-items: center; gap: 10px;
        }

        .field-group { 
            flex: 1; background: var(--blanco); border-radius: 25px; 
            display: flex; align-items: center; padding: 5px 15px;
        }

        .field-group input { 
            flex: 1; border: none; padding: 10px; outline: none; font-size: 15px; 
        }

        .send-btn { 
            width: 48px; height: 48px; border-radius: 50%; border: none; 
            background: var(--verde-wa); color: white; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
        }

        .badge { background: var(--verde-imperio); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="view-container" id="master-view">
    
    <div class="screen">
        <header class="list-header">
            <h1>Rantikuy Chat</h1>
            <div class="badge">NEGOCIOS</div>
        </header>
        <div class="chat-list" id="inbox-list">
            </div>
        <button onclick="location.href='index.html'" style="margin: 20px; padding: 15px; border-radius: 15px; border: none; background: var(--oscuro); color: white; font-weight: 800;">VOLVER AL MERCADO</button>
    </div>

    <div class="screen chat-screen">
        <header class="chat-header">
            <div class="back-area" onclick="closeChat()">
                <span>‚ùÆ</span>
                <div class="avatar-lg" id="p-avatar" style="width: 38px; height: 38px; font-size: 14px;">?</div>
            </div>
            <div style="flex: 1;">
                <b id="p-name" style="font-size: 16px;">Comerciante</b>
                <div style="font-size: 10px; color: var(--verde-imperio); font-weight: 700;">TIENDA VERIFICADA</div>
            </div>
            <button onclick="clearHistory()" style="background: none; border: none;">üóëÔ∏è</button>
        </header>

        <div class="msg-area" id="msg-flow"></div>

        <div class="quick-bar">
            <div class="q-chip" onclick="fastMsg('¬øEst√° disponible?')">üõçÔ∏è ¬øDisponible?</div>
            <div class="q-chip" onclick="fastMsg('¬øHaces delivery?')">üõµ ¬øDelivery?</div>
            <div class="q-chip" onclick="fastMsg('¬øAceptas Yape?')">üíú ¬øYape?</div>
        </div>

        <div class="input-box">
            <div class="field-group">
                <button onclick="upload()" style="background:none; border:none; font-size:20px;">üì∑</button>
                <input type="text" id="main-in" placeholder="Escribe un mensaje..." autocomplete="off">
            </div>
            <button class="send-btn" onclick="handleSend()">‚úàÔ∏è</button>
        </div>
    </div>
</div>

<script>
    const me = localStorage.getItem('rantiy_user') || "Invitado";
    let activePartner = "";

    function init() {
        renderInbox();
        
        // Si vienes de la vitrina con un partner espec√≠fico
        const direct = localStorage.getItem('last_chat_partner');
        if(direct) {
            localStorage.removeItem('last_chat_partner');
            openChat(direct);
        }

        setInterval(() => {
            if(activePartner) loadMsgs();
            renderInbox();
        }, 3000);

        document.getElementById('main-in').onkeypress = (e) => { if(e.key === 'Enter') handleSend(); };
    }

    function renderInbox() {
        const inbox = document.getElementById('inbox-list');
        const data = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
        let html = "";

        const myChats = Object.keys(data).filter(key => key.includes(me));

        if(myChats.length === 0) {
            inbox.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8;">
                <div style="font-size:50px;">üí¨</div>
                <p>No hay mensajes todav√≠a.<br>Inicia una charla en la vitrina.</p>
            </div>`;
            return;
        }

        myChats.forEach(key => {
            const partnerName = key.replace(me, "").replace("_", "");
            const msgs = data[key];
            const last = msgs[msgs.length - 1] || {t: "Sin mensajes", h:""};
            
            html += `
                <div class="chat-item" onclick="openChat('${partnerName}')">
                    <div class="avatar-lg">${partnerName.charAt(0).toUpperCase()}</div>
                    <div class="chat-meta">
                        <div><b>${partnerName}</b> <span>${last.h}</span></div>
                        <p>${last.type === 'img' ? 'üì∑ Foto' : last.t}</p>
                    </div>
                </div>
            `;
        });
        inbox.innerHTML = html;
    }

    function openChat(name) {
        activePartner = name;
        document.getElementById('p-name').innerText = name;
        document.getElementById('p-avatar').innerText = name.charAt(0).toUpperCase();
        document.getElementById('master-view').classList.add('view-active-chat');
        loadMsgs();
    }

    function closeChat() {
        activePartner = "";
        document.getElementById('master-view').classList.remove('view-active-chat');
    }

    function loadMsgs() {
        const flow = document.getElementById('msg-flow');
        const data = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
        const key = [me, activePartner].sort().join('_');
        const msgs = data[key] || [];

        const html = msgs.map(m => `
            <div class="bubble ${m.u === me ? 'bubble-out' : 'bubble-in'}">
                ${m.type === 'img' ? `<img src="${m.t}">` : m.t}
                <span class="time">${m.h}</span>
            </div>
        `).join('');

        if(flow.innerHTML !== html) {
            flow.innerHTML = html;
            flow.scrollTop = flow.scrollHeight;
        }
    }

    function handleSend() {
        const input = document.getElementById('main-in');
        if(!input.value.trim()) return;
        save(input.value, 'text');
        input.value = "";
    }

    function save(txt, type) {
        let data = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
        const key = [me, activePartner].sort().join('_');
        if(!data[key]) data[key] = [];
        
        data[key].push({
            u: me, t: txt, type: type, 
            h: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12: true})
        });
        
        localStorage.setItem('empire_private_chats', JSON.stringify(data));
        loadMsgs();
    }

    function fastMsg(t) { save(t, 'text'); }

    function upload() {
        let i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = e => {
            let r = new FileReader();
            r.onload = ev => save(ev.target.result, 'img');
            r.readAsDataURL(e.target.files[0]);
        };
        i.click();
    }

    function clearHistory() {
        if(confirm("¬øEliminar este chat?")) {
            let data = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
            delete data[[me, activePartner].sort().join('_')];
            localStorage.setItem('empire_private_chats', JSON.stringify(data));
            closeChat();
            renderInbox();
        }
    }

    window.onload = init;
</script>
</body>
</html>
