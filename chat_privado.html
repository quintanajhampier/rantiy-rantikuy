<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rantikuy Empire - Business OS V9 LEGACY</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --p-green: #10b981;
            --p-vibrant-green: #22c55e;
            --p-gold: #f59e0b;
            --p-sky: #0ea5e9;
            --p-light: #f8fafc;
            --p-white: #ffffff;
            --p-dark: #1e293b;
            --p-slate: #64748b;
            --p-red: #f43f5e;
            --p-soft-gold: #fef3c7;
            --shadow-premium: 0 20px 40px -10px rgba(16, 185, 129, 0.2);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', sans-serif; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }

        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: var(--p-light); overflow: hidden; color: var(--p-dark); }

        .app-shell { display: flex; width: 200%; height: 100%; transition: transform 0.7s cubic-bezier(0.19, 1, 0.22, 1); }
        .view-is-chat { transform: translateX(-50%); }

        .screen { width: 50%; height: 100%; display: flex; flex-direction: column; background: var(--p-white); position: relative; }

        /* HEADER VIBRANTE - ESTILO HUANTA MARKET */
        .header-main { 
            padding: 25px 30px; 
            background: linear-gradient(135deg, var(--p-white) 0%, #f0fdf4 100%);
            border-bottom: 2px solid #ecfdf5;
            display: flex; justify-content: space-between; align-items: center; 
            z-index: 100;
        }
        .header-title { cursor: pointer; user-select: none; }
        .header-title h1 { margin: 0; font-size: 26px; font-weight: 800; letter-spacing: -1.2px; color: var(--p-dark); }
        .header-title h1 span { color: var(--p-vibrant-green); }
        .header-title p { margin: 0; font-size: 10px; font-weight: 700; color: var(--p-green); text-transform: uppercase; letter-spacing: 1.5px; }

        /* LISTADO DE NEGOCIOS PRO */
        .biz-scroll { flex: 1; overflow-y: auto; padding: 20px; background: #fcfdfc; }
        .biz-card { 
            background: var(--p-white); padding: 20px; border-radius: 30px; 
            display: flex; align-items: center; gap: 18px; margin-bottom: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.03); border: 1px solid #f1f5f9;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .biz-card:active { transform: scale(0.95); background: #f0fdf4; }
        
        .biz-img { 
            width: 70px; height: 70px; border-radius: 22px; 
            background: linear-gradient(135deg, var(--p-vibrant-green), var(--p-sky));
            display: flex; align-items: center; justify-content: center; 
            color: white; font-weight: 800; font-size: 24px; 
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.2); position: relative;
        }
        .online-ring { 
            position: absolute; bottom: -4px; right: -4px; width: 20px; height: 20px; 
            background: #22c55e; border: 4px solid #fff; border-radius: 50%;
        }

        /* CHAT ENGINE V9 */
        .chat-bg { background: #f0f2f5 url('https://www.transparenttextures.com/patterns/cubes.png'); }
        .chat-nav { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            padding: 15px 25px; display: flex; align-items: center; gap: 15px; 
            border-bottom: 1px solid #e2e8f0; z-index: 100;
        }

        /* BARRA DE CONFIANZA */
        .trust-meter { height: 4px; background: #e2e8f0; width: 100%; position: relative; overflow: hidden; }
        .trust-fill { height: 100%; background: var(--p-vibrant-green); width: 65%; transition: 1s; }

        /* NEGOTIATION HUB */
        .nego-panel { 
            margin: 15px; background: white; border-radius: 35px; padding: 20px;
            box-shadow: var(--shadow-premium); border: 1px solid #f1f5f9;
        }
        .contract-badge {
            background: var(--p-soft-gold); color: var(--p-gold);
            padding: 5px 12px; border-radius: 12px; font-size: 10px; font-weight: 800;
        }

        /* FLOW DE MENSAJES */
        .messages-container { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 20px; }
        .bubble { 
            max-width: 80%; padding: 16px 20px; border-radius: 28px; 
            font-size: 15px; line-height: 1.5; position: relative; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.02); animation: msgPop 0.4s ease-out;
        }
        @keyframes msgPop { from { transform: scale(0.8); opacity: 0; } }

        .msg-me { align-self: flex-end; background: var(--p-vibrant-green); color: white; border-bottom-right-radius: 4px; }
        .msg-them { align-self: flex-start; background: white; color: var(--p-dark); border-bottom-left-radius: 4px; }

        /* TARJETA DE OFERTA FORMAL */
        .offer-box { 
            background: #fff; border: 2px dashed var(--p-gold); border-radius: 20px; 
            padding: 15px; margin: 10px 0; text-align: center;
        }
        .offer-val { font-size: 28px; font-weight: 900; color: var(--p-dark); display: block; margin: 5px 0; }

        /* DOCK DE ACCIONES PROFESIONALES */
        .biz-actions { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; 
            padding: 15px 20px; background: #f8fafc; border-top: 1px solid #e2e8f0;
        }
        .action-node { 
            background: white; border: 1px solid #e2e8f0; padding: 12px 5px; border-radius: 20px; 
            font-size: 11px; font-weight: 800; color: var(--p-dark);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: 0.2s;
        }
        .action-node:active { transform: translateY(3px); background: var(--p-vibrant-green); color: white; }

        /* INPUT AREA V9 */
        .input-wrapper { background: white; padding: 15px 20px calc(20px + var(--safe-bottom)); }
        .input-field { display: flex; align-items: center; gap: 12px; }
        .input-capsule { 
            flex: 1; background: #f1f5f9; border-radius: 35px; 
            padding: 5px 20px; display: flex; align-items: center; border: 1px solid #e2e8f0;
        }
        .input-capsule input { flex: 1; border: none; background: transparent; padding: 14px 0; outline: none; font-size: 15px; font-weight: 600; }
        
        .btn-round { width: 55px; height: 55px; border-radius: 50%; border: none; background: var(--p-dark); color: white; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .btn-round:hover { transform: rotate(15deg) scale(1.1); }
        .btn-green { background: var(--p-vibrant-green); box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3); }

        /* MODALES */
        .full-modal {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.95);
            display: none; z-index: 2000; justify-content: center; align-items: center; padding: 25px;
        }
        .modal-content { background: white; width: 100%; max-width: 450px; border-radius: 40px; padding: 35px; position: relative; }

        /* ADMIN PANEL OVERLAY */
        #adminPanel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #0f0; font-family: 'Courier New', monospace;
            padding: 40px; z-index: 9999; display: none; overflow-y: auto;
        }
    </style>
</head>
<body>

<div id="adminPanel">
    <h2>> RANTIKUY_EMPIRE_OS_V9</h2>
    <p>> Acceso concedido: Lider Supremo</p>
    <hr>
    <p>> Base de datos: ONLINE</p>
    <p>> Servidores Huanta: ACTIVO</p>
    <div id="dbLog"></div>
    <button onclick="closeAdmin()" style="background:#0f0; color:#000; border:none; padding:10px; margin-top:20px; font-weight:bold;">SALIR_SISTEMA</button>
</div>

<div class="app-shell" id="appShell">
    
    <div class="screen">
        <div class="trust-meter"><div class="trust-fill" id="totalTrust"></div></div>
        <header class="header-main">
            <div class="header-title" onclick="adminTrigger()">
                <h1 id="mainTitle">Rantikuy<span>.Empire</span></h1>
                <p>Centro de Mando Huanta</p>
            </div>
            <div id="walletDisplay" style="background: var(--p-soft-gold); padding: 10px 18px; border-radius: 20px; font-weight: 800; font-size: 13px; color: var(--p-gold);">
                S/ 2,450.00
            </div>
        </header>
        
        <div style="padding: 20px 30px; font-weight: 800; font-size: 13px; color: var(--p-slate); letter-spacing: 1px;">NEGOCIACIONES EN VIVO</div>
        <div class="biz-scroll" id="inbox"></div>

        <nav style="padding: 20px; background: white; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: center;">
            <button class="btn-round" style="background:none; color:var(--p-slate);">üè†</button>
            <button class="btn-round" style="background:var(--p-vibrant-green); color:white; width:65px; height:65px; font-size:28px;">üí¨</button>
            <button class="btn-round" style="background:none; color:var(--p-slate);">üì¶</button>
            <button class="btn-round" style="background:none; color:var(--p-slate);">üë§</button>
        </nav>
    </div>

    <div class="screen chat-bg">
        <nav class="chat-nav">
            <button onclick="goToInbox()" style="border:none; background:none; font-size:24px; color:var(--p-dark);">‚ùÆ</button>
            <div class="biz-img" id="chatAvatar" style="width:50px; height:50px; font-size:18px;">?</div>
            <div style="flex:1">
                <b id="chatName" style="font-size:18px;">Empresario</b>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="color:var(--p-vibrant-green); font-size:10px; font-weight:800;">‚óè NEGOCIACI√ìN SEGURA</span>
                </div>
            </div>
            <button class="btn-round" style="width:40px; height:40px; background:#f1f5f9; color:var(--p-dark); font-size:18px;">üìû</button>
        </nav>

        <div class="nego-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <span class="contract-badge" id="negoID">ID: -- -- --</span>
                <span id="dealStatus" style="background:#dcfce7; color:#166534; padding:5px 12px; border-radius:12px; font-size:10px; font-weight:800;">ACTIVO</span>
            </div>
            <div style="display:flex; align-items:center; gap:15px;">
                <div id="productThumb" style="width:55px; height:55px; border-radius:15px; background:#f8fafc; display:flex; align-items:center; justify-content:center; font-size:24px;">üì¶</div>
                <div style="flex:1">
                    <b id="dealTitle" style="font-size:15px;">Iniciando Trato...</b><br>
                    <span style="font-size:14px; color:var(--p-vibrant-green); font-weight:800;">S/ <span id="currentPrice">0.00</span></span>
                </div>
                <button onclick="confirmDeal()" style="background:var(--p-dark); color:white; border:none; padding:12px 18px; border-radius:18px; font-weight:800; font-size:11px;">CERRAR TRATO</button>
            </div>
        </div>

        <div class="messages-container" id="msgFlow"></div>

        <div class="biz-actions">
            <button class="action-node" onclick="openOfferModal()">üí∞ Ofertar</button>
            <button class="action-node" onclick="sendQuickMsg('üìç Plaza de Armas?')">üìç Lugar</button>
            <button class="action-node" onclick="openPaymentModal()">üí≥ Pagar</button>
            <button class="action-node" onclick="toggleStickers()">‚ú® Reacci√≥n</button>
        </div>

        <div class="input-wrapper">
            <div id="stickerDrawer" style="display:none; grid-template-columns:repeat(5,1fr); gap:15px; margin-bottom:15px; background:#f8fafc; padding:15px; border-radius:25px; border:1px solid #e2e8f0;">
                <div onclick="sendSticker('ü§ù')" style="font-size:32px; text-align:center; cursor:pointer;">ü§ù</div>
                <div onclick="sendSticker('üíé')" style="font-size:32px; text-align:center; cursor:pointer;">üíé</div>
                <div onclick="sendSticker('üî•')" style="font-size:32px; text-align:center; cursor:pointer;">üî•</div>
                <div onclick="sendSticker('üöÄ')" style="font-size:32px; text-align:center; cursor:pointer;">üöÄ</div>
                <div onclick="sendSticker('‚úÖ')" style="font-size:32px; text-align:center; cursor:pointer;">‚úÖ</div>
            </div>
            <div class="input-field">
                <button class="btn-round" style="background:#f1f5f9; color:var(--p-dark);" onclick="pickFile()">üìé</button>
                <div class="input-capsule">
                    <input type="text" id="userInput" placeholder="Escribe tu propuesta comercial...">
                </div>
                <button class="btn-round btn-green" onclick="processMessage()">üöÄ</button>
            </div>
        </div>
    </div>
</div>

<div class="full-modal" id="offerModal">
    <div class="modal-content">
        <h2 style="margin:0; font-size:24px; letter-spacing:-1px;">Nueva Contraoferta</h2>
        <p style="color:var(--p-slate); font-size:14px; margin:10px 0 25px;">El vendedor ver√° esta oferta como una propuesta formal.</p>
        <div style="background:#f8fafc; padding:25px; border-radius:30px; border:2px solid #e2e8f0; margin-bottom:25px;">
            <span style="font-weight:900; color:var(--p-vibrant-green); font-size:20px;">S/ </span>
            <input type="number" id="offerInput" style="background:none; border:none; font-size:38px; font-weight:900; width:80%; outline:none;" placeholder="0.00">
        </div>
        <div style="display:flex; gap:15px;">
            <button onclick="closeModal('offerModal')" style="flex:1; border:none; padding:18px; border-radius:22px; font-weight:800; background:#f1f5f9;">CANCELAR</button>
            <button onclick="submitOffer()" style="flex:1; border:none; background:var(--p-dark); color:white; padding:18px; border-radius:22px; font-weight:800;">ENVIAR</button>
        </div>
    </div>
</div>

<div class="full-modal" id="paymentModal">
    <div class="modal-content" style="text-align:center;">
        <div style="font-size:50px; margin-bottom:10px;">üí≥</div>
        <h2 style="margin:0;">M√©todo de Pago</h2>
        <p style="color:var(--p-slate); margin-bottom:25px;">Selecciona como deseas liquidar el trato.</p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:25px;">
            <div onclick="executePayment('YAPE')" style="background:#742284; color:white; padding:20px; border-radius:25px; font-weight:bold; cursor:pointer;">YAPE</div>
            <div onclick="executePayment('PLIN')" style="background:#00d1ce; color:white; padding:20px; border-radius:25px; font-weight:bold; cursor:pointer;">PLIN</div>
            <div onclick="executePayment('TRANSF.')" style="background:var(--p-dark); color:white; padding:20px; border-radius:25px; font-weight:bold; cursor:pointer;">TRANSF.</div>
            <div onclick="executePayment('EFECTIVO')" style="background:var(--p-vibrant-green); color:white; padding:20px; border-radius:25px; font-weight:bold; cursor:pointer;">EFECTIVO</div>
        </div>
        <button onclick="closeModal('paymentModal')" style="width:100%; border:none; padding:15px; background:none; font-weight:800; color:var(--p-slate);">VOLVER</button>
    </div>
</div>

<script>
    const APP_USER = localStorage.getItem('rantiy_user') || "Lider_Huanta";
    let ACTIVE_CHAT = "";
    let ADMIN_TAPS = 0;
    const DB_KEY = 'empire_v9_db';

    function boot() {
        renderInbox();
        document.getElementById('userInput').onkeypress = e => { if(e.key === 'Enter') processMessage(); };
        const last = localStorage.getItem('last_chat_partner');
        if(last) { localStorage.removeItem('last_chat_partner'); openChat(last); }
        
        // Efecto visual de wallet
        setInterval(() => {
            const val = 2450 + Math.random() * 10;
            document.getElementById('walletDisplay').innerText = `S/ ${val.toLocaleString()}`;
        }, 5000);

        setInterval(() => { renderInbox(); if(ACTIVE_CHAT) renderMessages(); }, 2000);
    }

    // DISPARADOR PANEL ADMIN (7 TAPS)
    function adminTrigger() {
        ADMIN_TAPS++;
        if(ADMIN_TAPS >= 7) {
            document.getElementById('adminPanel').style.display = 'block';
            const db = localStorage.getItem(DB_KEY);
            document.getElementById('dbLog').innerHTML = `<pre>${JSON.stringify(JSON.parse(db), null, 2)}</pre>`;
            ADMIN_TAPS = 0;
        }
        setTimeout(() => { if(ADMIN_TAPS < 7) ADMIN_TAPS = 0; }, 3000);
    }
    function closeAdmin() { document.getElementById('adminPanel').style.display = 'none'; }

    function renderInbox() {
        const inbox = document.getElementById('inbox');
        const db = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
        const chats = Object.keys(db).filter(k => k.includes(APP_USER));
        
        if(chats.length === 0) {
            inbox.innerHTML = `<div style="text-align:center; padding:80px 40px; color:var(--p-slate);"><div style="font-size:50px;">üå±</div><h3>Tu imperio comienza aqu√≠.</h3><p>Busca productos en el mercado para negociar.</p></div>`;
            return;
        }

        inbox.innerHTML = chats.map(k => {
            const partner = k.replace(APP_USER, "").replace("_", "");
            const lastMsg = db[k][db[k].length - 1];
            return `
                <div class="biz-card" onclick="openChat('${partner}')">
                    <div class="biz-img">${partner[0].toUpperCase()}<div class="online-ring"></div></div>
                    <div style="flex:1">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                            <b style="font-size:18px;">${partner}</b>
                            <span style="font-size:11px; font-weight:800; color:var(--p-slate);">${lastMsg.h}</span>
                        </div>
                        <p style="margin:0; font-size:14px; color:var(--p-slate); overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                            ${lastMsg.u === APP_USER ? '<span style="color:var(--p-green)">T√∫:</span> ' : ''}${lastMsg.type === 'offer' ? 'üí∞ Propuesta enviada' : lastMsg.t}
                        </p>
                    </div>
                </div>
            `;
        }).join('');
    }

    function openChat(name) {
        ACTIVE_CHAT = name;
        document.getElementById('chatName').innerText = name;
        document.getElementById('chatAvatar').innerText = name[0].toUpperCase();
        document.getElementById('appShell').classList.add('view-is-chat');
        document.getElementById('currentPrice').innerText = (50 + Math.random() * 450).toFixed(2);
        document.getElementById('negoID').innerText = "ID: " + Math.random().toString(36).substr(2, 9).toUpperCase();
        renderMessages();
    }

    function goToInbox() {
        ACTIVE_CHAT = "";
        document.getElementById('appShell').classList.remove('view-is-chat');
    }

    function renderMessages() {
        const flow = document.getElementById('msgFlow');
        const db = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
        const key = [APP_USER, ACTIVE_CHAT].sort().join('_');
        const msgs = db[key] || [];

        const html = msgs.map(m => {
            let body = m.t;
            if(m.type === 'offer') body = `<div class="offer-box"><span>OFERTA FORMAL</span><b class="offer-val">S/ ${m.t}</b><small>Sujeto a confirmaci√≥n</small></div>`;
            if(m.type === 'payment') body = `<div style="background:#dcfce7; padding:15px; border-radius:20px; text-align:center; color:#166534;"><b>‚úÖ PAGO REALIZADO</b><br>V√≠a ${m.t}<br><small>Ref: #PAY-${Math.floor(Math.random()*9999)}</small></div>`;
            if(m.type === 'img') body = `<img src="${m.t}" style="width:100%; border-radius:20px; border:2px solid #fff;">`;
            if(m.type === 'sticker') body = `<div style="font-size:70px; text-align:center;">${m.t}</div>`;

            return `
                <div class="bubble ${m.u === APP_USER ? 'msg-me' : 'msg-them'}">
                    ${body}
                    <div style="font-size:9px; opacity:0.6; text-align:right; margin-top:8px; font-weight:800;">${m.h} ${m.u === APP_USER ? '‚úì‚úì' : ''}</div>
                </div>
            `;
        }).join('');

        if(flow.innerHTML !== html) {
            flow.innerHTML = html;
            flow.scrollTop = flow.scrollHeight;
        }
    }

    function processMessage() {
        const input = document.getElementById('userInput');
        if(!input.value.trim()) return;
        saveToDB(input.value, 'text');
        input.value = "";
    }

    function saveToDB(txt, type) {
        let db = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
        const key = [APP_USER, ACTIVE_CHAT].sort().join('_');
        if(!db[key]) db[key] = [];
        db[key].push({
            u: APP_USER, t: txt, type: type,
            h: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
        });
        localStorage.setItem(DB_KEY, JSON.stringify(db));
        renderMessages();
    }

    // ACCIONES DE NEGOCIO
    function openOfferModal() { document.getElementById('offerModal').style.display = 'flex'; }
    function openPaymentModal() { document.getElementById('paymentModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function submitOffer() {
        const val = document.getElementById('offerInput').value;
        if(!val) return;
        saveToDB(val, 'offer');
        closeModal('offerModal');
        document.getElementById('offerInput').value = "";
    }

    function executePayment(method) {
        saveToDB(method, 'payment');
        closeModal('paymentModal');
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 }, colors: ['#10b981', '#ffffff'] });
    }

    function confirmDeal() {
        if(confirm("¬øConfirmar contrato y cerrar trato comercial?")) {
            saveToDB("ü§ù TRATO CERRADO. ¬°√âxito en el negocio!", "text");
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: ['#f59e0b', '#10b981', '#ffffff'] });
            document.getElementById('dealStatus').innerText = "CERRADO";
            document.getElementById('dealStatus').style.background = "var(--p-dark)";
            document.getElementById('dealStatus').style.color = "white";
        }
    }

    function sendQuickMsg(t) { saveToDB(t, 'text'); }
    function sendSticker(s) { saveToDB(s, 'sticker'); toggleStickers(); }
    function toggleStickers() {
        const d = document.getElementById('stickerDrawer');
        d.style.display = d.style.display === 'grid' ? 'none' : 'grid';
    }

    function pickFile() {
        let i = document.createElement('input'); i.type='file';
        i.onchange = e => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = ev => saveToDB(ev.target.result, f.type.includes('image') ? 'img' : 'text');
            r.readAsDataURL(f);
        };
        i.click();
    }

    window.onload = boot;
</script>
</body>
</html>
