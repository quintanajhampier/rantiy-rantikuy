<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rantikuy Empire Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --vibrant-green: #22c55e;
            --wa-green: #128c7e;
            --soft-bg: #f1f5f9;
            --white: #ffffff;
            --dark: #0f172a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--white); font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }

        /* CONTENEDOR MAESTRO DESLIZABLE */
        .app-container { display: flex; width: 200%; height: 100vh; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .show-chat { transform: translateX(-50%); }

        .screen { width: 50%; height: 100%; display: flex; flex-direction: column; background: var(--white); }

        /* HEADER ELITE */
        .header-pro { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
        .header-pro h1 { font-size: 28px; font-weight: 800; margin: 0; color: var(--vibrant-green); letter-spacing: -1px; }

        /* LISTA DE CHATS (INBOX) */
        .inbox-area { flex: 1; overflow-y: auto; padding: 15px; background: var(--soft-bg); }
        .chat-row { 
            background: var(--white); padding: 16px; border-radius: 24px; display: flex; align-items: center; gap: 15px; margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid transparent; transition: 0.3s;
        }
        .chat-row:active { transform: scale(0.97); border-color: var(--vibrant-green); }
        .avatar-circle { width: 55px; height: 55px; border-radius: 20px; background: linear-gradient(45deg, var(--vibrant-green), #15803d); color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; box-shadow: 0 4px 10px rgba(34,197,94,0.3); }

        /* PANTALLA DE CHAT (BUSINESS STYLE) */
        .chat-view { background: #efeae2 url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: 450px; }
        
        .chat-top { background: rgba(255,255,255,0.95); backdrop-filter: blur(15px); padding: 10px 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #ddd; z-index: 10; }
        .btn-back { width: 40px; height: 40px; border-radius: 50%; border: none; background: #f1f5f9; color: var(--dark); cursor: pointer; font-size: 18px; font-weight: 800; }

        /* EL APARTADO "CHIDO" DE NEGOCIO */
        .biz-info { background: var(--vibrant-green); color: white; padding: 8px 15px; font-size: 12px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }

        .messages-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .msg-me { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .msg-them { align-self: flex-start; background: var(--white); border-top-left-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* STICKERS */
        .sticker { font-size: 70px; background: none !important; box-shadow: none !important; padding: 0 !important; }

        /* BARRA DE ENTRADA PRO */
        .action-bar { padding: 10px 15px 30px; background: #f0f0f0; display: flex; align-items: center; gap: 8px; }
        .input-pill { flex: 1; background: var(--white); border-radius: 25px; padding: 5px 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .input-pill input { flex: 1; border: none; padding: 10px; outline: none; font-size: 15px; }
        .btn-send { width: 50px; height: 50px; border-radius: 50%; border: none; background: var(--wa-green); color: var(--white); font-size: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(18,140,126,0.3); transition: 0.2s; }
        .btn-send:active { transform: scale(0.85) rotate(-10deg); }

        /* ESTADO VAC√çO */
        .empty-state { text-align: center; padding-top: 100px; color: #94a3b8; }
        .empty-state i { font-size: 60px; display: block; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="app-container" id="app-shell">
    
    <div class="screen">
        <header class="header-pro">
            <h1>Imperio Chat</h1>
            <div style="background:var(--soft-bg); padding:5px 12px; border-radius:15px; font-size:12px; font-weight:800;">NEGOCIOS</div>
        </header>
        <div class="inbox-area" id="inbox-list">
            </div>
        <button onclick="location.href='index.html'" style="margin:20px; padding:18px; border-radius:20px; border:none; background:var(--dark); color:white; font-weight:800;">EXPLORAR MERCADO</button>
    </div>

    <div class="screen chat-view">
        <header class="chat-top">
            <button class="btn-back" onclick="toggleScreen(false)">‚ùÆ</button>
            <div class="avatar-circle" id="chat-avatar" style="width:42px; height:42px; font-size:16px;">?</div>
            <div style="flex:1">
                <b id="chat-title" style="font-size:17px; color:var(--dark); display:block;">...</b>
                <span style="font-size:11px; color:var(--vibrant-green); font-weight:700;">Activo ahora</span>
            </div>
            <button onclick="wipe()" style="background:none; border:none; font-size:22px;">üßπ</button>
        </header>
        
        <div class="biz-info">
            <span>ü§ù ACUERDO COMERCIAL SEGURO</span>
            <span onclick="alert('Ubicaci√≥n: Huanta Central')" style="text-decoration:underline">üìç Huanta</span>
        </div>

        <div class="messages-container" id="msg-box"></div>

        <div style="display:flex; gap:10px; padding:0 15px 10px; overflow-x:auto; scrollbar-width:none;">
            <button onclick="sendFast('¬øPrecio m√≠nimo?')" style="padding:8px 15px; border-radius:15px; border:1px solid #ddd; background:white; font-size:12px; white-space:nowrap; font-weight:700;">üí∞ Precio?</button>
            <button onclick="sendFast('¬øDonde entregas?')" style="padding:8px 15px; border-radius:15px; border:1px solid #ddd; background:white; font-size:12px; white-space:nowrap; font-weight:700;">üìç Entrega?</button>
            <button onclick="sendSticker('ü§ù')" style="font-size:20px; background:none; border:none;">ü§ù</button>
            <button onclick="sendSticker('‚úÖ')" style="font-size:20px; background:none; border:none;">‚úÖ</button>
        </div>

        <div class="action-bar">
            <div class="input-pill">
                <input type="text" id="chat-input" placeholder="Escribe un mensaje..." autocomplete="off">
                <button onclick="pickFile()" style="background:none; border:none; font-size:20px;">üì∑</button>
            </div>
            <button class="btn-send" onclick="doSend()">üöÄ</button>
        </div>
    </div>
</div>

<script>
    const myName = localStorage.getItem('rantiy_user') || "Yo";
    let activeP = "";

    function init() {
        refreshInbox();
        
        // El "Truco" del LocalStorage para conectar con la vitrina
        const partnerFromVitrina = localStorage.getItem('last_chat_partner');
        if(partnerFromVitrina) {
            localStorage.removeItem('last_chat_partner');
            startChat(partnerFromVitrina);
        }

        setInterval(() => {
            refreshInbox();
            if(activeP) renderMessages();
        }, 3000);

        document.getElementById('chat-input').onkeypress = e => { if(e.key === 'Enter') doSend(); };
    }

    function refreshInbox() {
        const list = document.getElementById('inbox-list');
        const db = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
        const myKeys = Object.keys(db).filter(k => k.includes(myName));

        if(myKeys.length === 0) {
            list.innerHTML = `<div class="empty-state"><i>üí¨</i><p>No hay tratos pendientes.<br>¬°Ve a la vitrina y empieza uno!</p></div>`;
            return;
        }

        list.innerHTML = myKeys.map(k => {
            const name = k.replace(myName, "").replace("_", "");
            const last = db[k][db[k].length - 1];
            return `
                <div class="chat-row" onclick="startChat('${name}')">
                    <div class="avatar-circle">${name[0].toUpperCase()}</div>
                    <div style="flex:1">
                        <div style="display:flex; justify-content:space-between;">
                            <b style="font-size:16px;">${name}</b>
                            <span style="font-size:11px; color:#94a3b8;">${last.h}</span>
                        </div>
                        <p style="margin:5px 0 0; font-size:13px; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;">
                            ${last.type === 'sticker' ? 'Envi√≥ una reacci√≥n ' + last.t : last.t}
                        </p>
                    </div>
                </div>
            `;
        }).join('');
    }

    function startChat(name) {
        activeP = name;
        document.getElementById('chat-title').innerText = name;
        document.getElementById('chat-avatar').innerText = name[0].toUpperCase();
        toggleScreen(true);
        renderMessages();
    }

    function toggleScreen(show) {
        document.getElementById('app-shell').classList.toggle('show-chat', show);
        if(!show) activeP = "";
    }

    function renderMessages() {
        const box = document.getElementById('msg-box');
        const db = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
        const key = [myName, activeP].sort().join('_');
        const msgs = db[key] || [];

        const html = msgs.map(m => `
            <div class="msg ${m.u === myName ? 'msg-me' : 'msg-them'} ${m.type === 'sticker' ? 'sticker' : ''}">
                ${m.type === 'img' ? `<img src="${m.t}" style="width:100%; border-radius:12px;">` : m.t}
                ${m.type === 'text' ? `<span style="font-size:9px; display:block; text-align:right; margin-top:5px; opacity:0.5;">${m.h}</span>` : ''}
            </div>
        `).join('');

        if(box.innerHTML !== html) {
            box.innerHTML = html;
            box.scrollTop = box.scrollHeight;
        }
    }

    function doSend() {
        const input = document.getElementById('chat-input');
        if(!input.value.trim()) return;
        pushMsg(input.value, 'text');
        input.value = "";
    }

    function sendFast(t) { pushMsg(t, 'text'); }
    function sendSticker(s) { pushMsg(s, 'sticker'); }

    function pushMsg(txt, type) {
        let db = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
        const key = [myName, activeP].sort().join('_');
        if(!db[key]) db[key] = [];
        
        db[key].push({
            u: myName, t: txt, type: type,
            h: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
        });
        
        localStorage.setItem('empire_private_chats', JSON.stringify(db));
        renderMessages();
    }

    function pickFile() {
        let i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = e => {
            let r = new FileReader();
            r.onload = ev => pushMsg(ev.target.result, 'img');
            r.readAsDataURL(e.target.files[0]);
        };
        i.click();
    }

    function wipe() {
        if(confirm("¬øBorrar historial con este vendedor?")) {
            let db = JSON.parse(localStorage.getItem('empire_private_chats') || '{}');
            delete db[[myName, activeP].sort().join('_')];
            localStorage.setItem('empire_private_chats', JSON.stringify(db));
            toggleScreen(false);
            refreshInbox();
        }
    }

    window.onload = init;
</script>
</body>
</html>
