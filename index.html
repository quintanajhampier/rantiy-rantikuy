<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rantiy y Rantikuy - Imperio Huanta</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --verde: #22c55e; --verde-glow: #dcfce7;
            --naranja: #f97316; --oscuro: #1e293b;
            --glass: rgba(255, 255, 255, 0.96);
            --huanta: #22c55e; --huamanga: #3b82f6; --vraem: #f59e0b;
            --premium-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', sans-serif; outline: none; }
        
        /* Ajuste App Real: Evita scroll innecesario y fija el alto */
        body, html { 
            background: #f8fafc; margin: 0; 
            overflow: hidden; color: var(--oscuro); 
            height: 100%; width: 100%; position: fixed;
        }

        /* --- BLOQUEO GPS --- */
        #gps-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .gps-loader { width: 80px; height: 80px; border: 8px solid #f3f3f3; border-top: 8px solid var(--verde); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- CONTENEDOR PRINCIPAL --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* --- HEADER --- */
        .header {
            background: var(--glass); backdrop-filter: blur(25px); padding: 15px 20px;
            display: flex; align-items: center; justify-content: space-between;
            z-index: 2000; border-bottom: 1px solid rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        .logo-rr {
            width: 50px; height: 50px; background: linear-gradient(135deg, var(--verde), #15803d);
            border-radius: 18px; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 900; font-size: 20px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3);
        }

        /* --- AREA SCROLLABLE (VITRINA) --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 100px; /* Espacio para la Nav Island */
            -webkit-overflow-scrolling: touch;
        }

        /* --- VITRINA / CARDS --- */
        .post-card { background: white; border-radius: 30px; padding: 15px; box-shadow: var(--premium-shadow); margin: 15px 20px; position: relative; }
        .img-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; scrollbar-width: none; }
        .img-scroll img { width: 100%; height: 200px; object-fit: cover; border-radius: 20px; flex-shrink: 0; }
        
        .btn-delete {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255, 0, 0, 0.1); color: #ef4444;
            border: none; padding: 8px; border-radius: 12px; font-weight: 800; font-size: 10px;
        }

        /* --- CHAT GRUPAL (CORREGIDO) --- */
        #view-chat {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .chat-box-ui { 
            flex: 1; display: flex; flex-direction: column; background: #f1f5f9; 
            margin: 10px; border-radius: 30px; overflow: hidden; margin-bottom: 90px;
        }
        .msg-area { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .chat-input-container {
            padding: 10px; background: white; display: flex; gap: 10px; align-items: center;
            border-top: 1px solid #e2e8f0;
        }

        /* --- NAV ISLAND (FIJA) --- */
        .nav-island { 
            position: fixed; bottom: 20px; left: 5%; width: 90%; 
            background: var(--oscuro); border-radius: 35px; 
            display: flex; justify-content: space-around; padding: 15px; z-index: 3000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .nav-btn { color: #94a3b8; text-align: center; font-size: 9px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .nav-btn.active { color: var(--verde); transform: translateY(-5px); }

        /* Estilos de b√∫squeda y filtros */
        .search-container { padding: 15px 20px 0; }
        .search-input { width: 100%; padding: 15px 20px 15px 45px; border-radius: 20px; border: none; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .filter-bar { padding: 10px 20px; display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
        .filter-chip { padding: 8px 16px; background: white; border-radius: 15px; font-size: 11px; font-weight: 700; white-space: nowrap; border: 2px solid transparent; }
        .filter-active { border-color: var(--verde); color: var(--verde); background: var(--verde-glow); }

        .city-bar { padding: 10px 20px; display: flex; gap: 10px; overflow-x: auto; }
        .city-card { min-width: 100px; padding: 12px; background: white; border-radius: 20px; text-align: center; font-size: 10px; font-weight: 800; opacity: 0.4; border: 2px solid transparent; }
        .active-city { opacity: 1; border-color: var(--verde); }

        /* Vistas */
        .view { display: none; height: 100%; }
        .view-active { display: flex; flex-direction: column; }
    </style>
</head>
<body>

<div id="gps-screen">
    <div class="logo-rr" style="width:80px; height:80px; font-size:30px;">R&R</div>
    <h2 style="font-weight:900;">Verificando Ciudadan√≠a...</h2>
    <div class="gps-loader"></div>
    <p id="gps-msg" style="color:var(--verde); font-weight:700;">Conectando con el sat√©lite de Huanta...</p>
</div>

<div class="app-container">
    <header class="header">
        <div style="display:flex; align-items:center; gap:12px;">
            <div class="logo-rr" onclick="checkAdminAccess()">R&R</div>
            <div>
                <div style="font-weight: 800; font-size: 16px; line-height: 1;">Rantiy y Rantikuy</div>
                <div id="user-tag" style="font-size: 9px; color: var(--verde); font-weight: 800;">CARGANDO...</div>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="header-chat-icon" onclick="window.location.href='chat_privado.html'">üí¨</div>
        </div>
    </header>

    <div id="view-home" class="view view-active">
        <div class="search-container">
            <input type="text" id="main-search" class="search-input" placeholder="üîç Buscar en el Imperio..." oninput="renderFeed()">
        </div>
        
        <div class="filter-bar">
            <div class="filter-chip filter-active" onclick="filterByCat('Todas', this)">‚ú® Todas</div>
            <div class="filter-chip" onclick="filterByCat('Venta', this)">üõçÔ∏è Venta</div>
            <div class="filter-chip" onclick="filterByCat('Comida', this)">üç≤ Comida</div>
            <div class="filter-chip" onclick="filterByCat('Taxi', this)">üöï Taxi</div>
        </div>

        <div class="city-bar">
            <div class="city-card" id="city-huanta">‚õ∞Ô∏è HUANTA</div>
            <div class="city-card" id="city-huamanga">‚õ™ HUAMANGA</div>
            <div class="city-card" id="city-vraem">üåø VRAEM</div>
        </div>

        <div class="main-content" id="feed-container">
            </div>
    </div>

    <div id="view-camera" class="view">
        <div class="main-content">
            <div class="camera-hub" id="main-hub" style="margin: 20px; background: var(--oscuro); border-radius: 30px; padding: 30px; color: white; text-align: center;">
                <h3 style="font-weight:900;">Publicar en <span id="current-zone-text">...</span></h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div class="cat-btn" onclick="startStudio('Venta', 'üõçÔ∏è')" style="background:rgba(255,255,255,0.1); padding:15px; border-radius:15px; font-size:10px;">üõçÔ∏è<br>VENTA</div>
                    <div class="cat-btn" onclick="startStudio('Comida', 'üç≤')" style="background:rgba(255,255,255,0.1); padding:15px; border-radius:15px; font-size:10px;">üç≤<br>COMIDA</div>
                    <div class="cat-btn" onclick="startStudio('Taxi', 'üöï')" style="background:rgba(255,255,255,0.1); padding:15px; border-radius:15px; font-size:10px;">üöï<br>TAXI</div>
                </div>
            </div>

            <div id="upload-studio" style="display:none; padding:20px;">
                <div class="photo-grid" style="display:grid; grid-template-columns: repeat(2,1fr); gap:10px;">
                    <div class="drop-zone" onclick="capture('cam', 0)" style="height:100px; border:2px dashed #ccc; border-radius:20px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                        <img id="img-0" style="width:100%; height:100%; object-fit:cover; display:none;">
                        <span id="info-0">üì∑ Foto 1</span>
                    </div>
                    <div class="drop-zone" onclick="capture('cam', 1)" style="height:100px; border:2px dashed #ccc; border-radius:20px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                        <img id="img-1" style="width:100%; height:100%; object-fit:cover; display:none;">
                        <span id="info-1">üì∑ Foto 2</span>
                    </div>
                </div>
                <input type="text" id="in-title" class="rr-field" placeholder="¬øQu√© vendes?" style="width:100%; margin-top:15px; padding:15px; border-radius:15px; border:1px solid #ddd;">
                <input type="number" id="in-price" class="rr-field" placeholder="Precio S/" style="width:100%; margin-top:10px; padding:15px; border-radius:15px; border:1px solid #ddd;">
                <button onclick="uploadToEmpire()" style="width:100%; padding:20px; background:var(--verde); color:white; border:none; border-radius:20px; font-weight:900; margin-top:15px;">PUBLICAR AHORA üöÄ</button>
                <button onclick="exitStudio()" style="width:100%; background:none; border:none; color:gray; margin-top:10px;">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="view-chat" class="view">
        <div class="chat-box-ui">
            <div style="padding:15px; background:var(--verde); color:white; font-weight:800; font-size:14px;" id="zone-chat-label">SALA DE CHAT</div>
            <div class="msg-area" id="group-msgs"></div>
            <div class="chat-input-container">
                <input type="text" id="group-input" style="flex:1; border:none; padding:12px; background:#f1f5f9; border-radius:15px;" placeholder="Escribe al grupo...">
                <button onclick="sendGroup()" style="background:var(--verde); color:white; border:none; padding:12px 20px; border-radius:15px; font-weight:800;">‚úàÔ∏è</button>
            </div>
        </div>
    </div>

    <nav class="nav-island">
        <div class="nav-btn active" onclick="tab('home', this)">üè†<br>VITRINA</div>
        <div class="nav-btn" onclick="tab('camera', this)">üì∏<br>SUBIR</div>
        <div class="nav-btn" onclick="tab('chat', this)">üí¨<br>GRUPAL</div>
    </nav>
</div>

<script>
    let activeLoc = ""; 
    let currentFilter = "Todas"; 
    let capturedFiles = [null, null]; 
    let currentUser = "";
    let adminClicks = 0;

    const ZONAS = {
        "Huanta": { lat: -12.94, lon: -74.24, r: 0.1 },
        "Huamanga": { lat: -13.15, lon: -74.22, r: 0.1 },
        "VRAEM": { lat: -12.50, lon: -73.80, r: 0.2 }
    };

    function init() {
        // Conexi√≥n con carpeta de registro
        currentUser = localStorage.getItem('rantiy_user') || localStorage.getItem('admin_session');
        if(!currentUser) { window.location.href = 'registro_entrada.html'; return; }
        document.getElementById('user-tag').innerText = "CIUDADANO: " + currentUser.toUpperCase();

        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(successGPS, errorGPS);
        }

        // Sincronizaci√≥n en tiempo real (WhatsApp style)
        window.addEventListener('storage', () => {
            renderFeed();
            loadGroupMsgs();
        });

        setInterval(() => {
            renderFeed();
            loadGroupMsgs();
        }, 2000);
    }

    function successGPS(pos) {
        let lat = pos.coords.latitude;
        let lon = pos.coords.longitude;
        let found = false;

        for (let zone in ZONAS) {
            let d = Math.sqrt(Math.pow(lat - ZONAS[zone].lat, 2) + Math.pow(lon - ZONAS[zone].lon, 2));
            if (d < ZONAS[zone].r) {
                activeLoc = zone;
                found = true;
                break;
            }
        }

        if (found) {
            document.getElementById('gps-screen').style.fadeOut = "slow";
            setTimeout(()=> document.getElementById('gps-screen').style.display = 'none', 500);
            document.querySelectorAll('.city-card').forEach(c => c.classList.remove('active-city'));
            document.getElementById('city-' + activeLoc.toLowerCase()).classList.add('active-city');
            document.getElementById('current-zone-text').innerText = activeLoc;
            document.getElementById('zone-chat-label').innerText = "SALA " + activeLoc.toUpperCase();
            renderFeed();
        } else {
            document.getElementById('gps-msg').innerText = "EST√ÅS FUERA DEL IMPERIO.";
        }
    }

    function errorGPS() { document.getElementById('gps-msg').innerText = "ACTIVA TU GPS PARA ENTRAR."; }

    function renderFeed() {
        if(!activeLoc) return;
        const container = document.getElementById('feed-container');
        const search = document.getElementById('main-search').value.toLowerCase();
        let posts = JSON.parse(localStorage.getItem('empire_posts') || '[]');
        
        let filtered = posts.filter(p => p.city === activeLoc && (currentFilter === "Todas" || p.category === currentFilter) && p.title.toLowerCase().includes(search));
        
        container.innerHTML = filtered.map(p => `
            <div class="post-card">
                ${(p.user === currentUser || localStorage.getItem('admin_session')) ? `<button class="btn-delete" onclick="deletePost(${p.id})">ELIMINAR</button>` : ''}
                <div class="img-scroll">${p.imgs.map(img => `<img src="${img}">`).join('')}</div>
                <h3 style="margin:5px 0; font-size:16px;">${p.title} <span style="color:var(--verde)">S/ ${p.price}</span></h3>
                <p style="font-size:11px; opacity:0.6; margin-bottom:10px;">Vendedor: ${p.user}</p>
                <button onclick="window.location.href='chat_privado.html?partner=${p.user}'" style="width:100%; padding:12px; background:var(--oscuro); color:white; border-radius:15px; border:none; font-weight:800; font-size:12px;">ENVIAR MENSAJE</button>
            </div>`).join('') || '<p style="text-align:center; padding:50px; opacity:0.5;">No hay nada en esta zona todav√≠a.</p>';
    }

    function deletePost(id) {
        if(confirm("¬øSeguro que quieres borrar esta publicaci√≥n?")) {
            let posts = JSON.parse(localStorage.getItem('empire_posts') || '[]');
            posts = posts.filter(p => p.id !== id);
            localStorage.setItem('empire_posts', JSON.stringify(posts));
            renderFeed();
        }
    }

    function uploadToEmpire() {
        const title = document.getElementById('in-title').value;
        const price = document.getElementById('in-price').value;
        if(!title || !capturedFiles[0]) return alert("Ponle un t√≠tulo y una foto.");

        const post = { 
            id: Date.now(), 
            user: currentUser, 
            title, 
            price, 
            city: activeLoc, 
            category: activeCat, 
            imgs: capturedFiles.filter(f => f) 
        };
        
        let posts = JSON.parse(localStorage.getItem('empire_posts') || '[]');
        posts.unshift(post);
        localStorage.setItem('empire_posts', JSON.stringify(posts));
        confetti(); 
        exitStudio(); 
        tab('home', document.querySelector('.nav-btn'));
        renderFeed();
    }

    function loadGroupMsgs() {
        if(!activeLoc) return;
        const area = document.getElementById('group-msgs');
        let msgs = JSON.parse(localStorage.getItem('group_messages_' + activeLoc) || '[]');
        area.innerHTML = msgs.map(m => `
            <div style="align-self: ${m.u===currentUser?'flex-end':'flex-start'}; background: ${m.u===currentUser?var(--verde):'white'}; color: ${m.u===currentUser?'white':'black'}; padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <b style="font-size:10px; opacity:0.7;">${m.u}</b><br>${m.t}
            </div>`).join('');
        area.scrollTop = area.scrollHeight;
    }

    function sendGroup() {
        let t = document.getElementById('group-input').value; 
        if(!t) return;
        let msgs = JSON.parse(localStorage.getItem('group_messages_' + activeLoc) || '[]');
        msgs.push({u: currentUser, t: t});
        localStorage.setItem('group_messages_' + activeLoc, JSON.stringify(msgs));
        document.getElementById('group-input').value="";
        loadGroupMsgs();
    }

    function tab(id, el) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('view-active'));
        document.getElementById('view-'+id).classList.add('view-active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    function capture(mode, i) {
        let input = document.createElement('input'); 
        input.type='file'; 
        input.accept='image/*';
        input.onchange = (e) => {
            const r = new FileReader();
            r.onload = (ev) => {
                capturedFiles[i] = ev.target.result;
                document.getElementById(`img-${i}`).src=ev.target.result;
                document.getElementById(`img-${i}`).style.display='block';
                document.getElementById(`info-${i}`).style.display='none';
            };
            r.readAsDataURL(e.target.files[0]);
        };
        input.click();
    }

    function startStudio(cat, em) {
        activeCat = cat;
        document.getElementById('main-hub').style.display='none';
        document.getElementById('upload-studio').style.display='block';
    }

    function exitStudio() {
        document.getElementById('main-hub').style.display='block';
        document.getElementById('upload-studio').style.display='none';
    }

    function filterByCat(c, el) { 
        currentFilter=c; 
        document.querySelectorAll('.filter-chip').forEach(x=>x.classList.remove('filter-active')); 
        el.classList.add('filter-active'); 
        renderFeed(); 
    }

    function checkAdminAccess() {
        adminClicks++;
        if(adminClicks >= 7) { window.location.href='admin.html'; }
        setTimeout(() => adminClicks=0, 3000);
    }

    window.onload = init;
</script>
</body>
</html>
