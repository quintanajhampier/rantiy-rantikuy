<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>R&R Imperio - Vitrina Real</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --verde: #22c55e; --verde-luz: #dcfce7; --oro: #fbbf24;
            --oscuro: #0f172a; --gris: #64748b; --blanco: #ffffff;
            --fondo: #f8fafc;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--fondo); color: var(--oscuro); overflow: hidden; }

        /* --- LAYOUT PRINCIPAL --- */
        .app-shell { display: flex; flex-direction: column; height: 100vh; }
        
        /* --- HEADER ELITE --- */
        header { 
            padding: 15px 20px; background: var(--blanco); border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .logo { font-weight: 800; font-size: 20px; letter-spacing: -1px; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--verde); }
        .admin-badge { background: var(--oro); color: var(--oscuro); font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 20px; box-shadow: 0 4px 10px rgba(250, 204, 21, 0.3); }

        /* --- SELECTOR DE ZONA --- */
        .zone-tabs { display: flex; padding: 10px 15px; gap: 10px; overflow-x: auto; background: var(--blanco); scrollbar-width: none; }
        .zone-chip { padding: 8px 18px; border-radius: 15px; background: #f1f5f9; font-size: 12px; font-weight: 700; white-space: nowrap; transition: 0.3s; color: var(--gris); border: 1px solid transparent; }
        .zone-chip.active { background: var(--verde-luz); color: var(--verde); border-color: var(--verde); }

        /* --- VISTAS --- */
        .view { flex: 1; overflow-y: auto; display: none; padding-bottom: 100px; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- VITRINA (GRID 2 COL) --- */
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; }
        .product-card { background: var(--blanco); border-radius: 20px; overflow: hidden; border: 1px solid rgba(0,0,0,0.03); position: relative; display: flex; flex-direction: column; }
        .product-card .img-container { width: 100%; aspect-ratio: 1/1; position: relative; }
        .product-card img { width: 100%; height: 100%; object-fit: cover; }
        .product-card .price { position: absolute; bottom: 8px; left: 8px; background: var(--verde); color: white; padding: 4px 10px; border-radius: 10px; font-weight: 800; font-size: 14px; }
        .product-card .delete-btn { position: absolute; top: 8px; right: 8px; background: #ff4757; color: white; border: none; width: 28px; height: 28px; border-radius: 8px; font-weight: 900; }
        .product-info { padding: 12px; flex: 1; }
        .product-info h3 { margin: 0; font-size: 13px; font-weight: 700; height: 2.6em; overflow: hidden; line-height: 1.3; }
        .product-info button { width: 100%; margin-top: 10px; padding: 10px; border-radius: 12px; border: none; background: var(--oscuro); color: white; font-size: 11px; font-weight: 800; }

        /* --- CHAT GRUPAL INTEGRADO --- */
        .group-chat-container { height: 100%; display: flex; flex-direction: column; padding: 15px; }
        #group-box { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .g-msg { max-width: 80%; padding: 10px 14px; border-radius: 15px; font-size: 13px; font-weight: 600; line-height: 1.4; position: relative; }
        .g-msg .u { font-size: 9px; font-weight: 800; display: block; margin-bottom: 2px; text-transform: uppercase; }
        .g-msg-me { align-self: flex-end; background: var(--verde); color: white; border-bottom-right-radius: 2px; }
        .g-msg-them { align-self: flex-start; background: white; border: 1px solid #e2e8f0; border-bottom-left-radius: 2px; }
        .chat-input-area { background: white; padding: 10px; border-radius: 20px; display: flex; gap: 10px; border: 1px solid #e2e8f0; }
        .chat-input-area input { flex: 1; border: none; font-weight: 600; font-size: 14px; }

        /* --- BARRA NAVEGACI√ìN --- */
        nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; background: var(--oscuro); padding: 10px; border-radius: 25px; display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .nav-btn { color: #94a3b8; text-align: center; border: none; background: none; font-size: 10px; font-weight: 800; cursor: pointer; }
        .nav-btn.active { color: var(--verde); }

        /* --- MODAL DE CARGA / BLOQUEO --- */
        #loader { position: fixed; inset: 0; background: white; z-index: 5000; display: flex; align-items: center; justify-content: center; text-align: center; }
        .loader-box { padding: 40px; }
        .spin { width: 50px; height: 50px; border: 4px solid #f1f5f9; border-top-color: var(--verde); border-radius: 50%; animation: s 1s linear infinite; margin: 0 auto 20px; }
        @keyframes s { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="loader-box">
        <div class="spin"></div>
        <h2 id="l-title">Conectando...</h2>
        <p id="l-msg">Sincronizando con el Imperio Real</p>
        <button id="l-btn" onclick="checkAccess()" style="display:none; padding:12px 25px; background:var(--verde); color:white; border:none; border-radius:15px; font-weight:800;">REINTENTAR ACCESO</button>
    </div>
</div>

<div class="app-shell">
    <header>
        <div class="logo">R&R <span>IMPERIO</span></div>
        <div id="admin-tag" class="admin-badge" style="display:none;">ADMIN MASTER</div>
        <div style="font-size: 10px; font-weight: 800; color: var(--gris);" id="user-display"></div>
    </header>

    <div class="zone-tabs" id="zone-selector">
        <div class="zone-chip active" onclick="setZone('HUANTA', this)">HUANTA</div>
        <div class="zone-chip" onclick="setZone('CUSCO', this)">CUSCO</div>
        <div class="zone-chip" onclick="setZone('VRAEM', this)">VRAEM</div>
    </div>

    <div id="v-market" class="view active">
        <div class="market-grid" id="market-feed"></div>
    </div>

    <div id="v-group" class="view">
        <div class="group-chat-container">
            <div id="group-box"></div>
            <div class="chat-input-area">
                <input type="text" id="g-input" placeholder="Mensaje al grupo...">
                <button onclick="sendGroupMsg()" style="background:var(--verde); color:white; border:none; padding:8px 15px; border-radius:12px; font-weight:800;">ENVIAR</button>
            </div>
        </div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="switchView('market', this)">üè†<br>VITRINA</button>
        <button class="nav-btn" onclick="alert('Usa el bot√≥n de subir en el panel Admin')">üì∏<br>SUBIR</button>
        <button class="nav-btn" onclick="switchView('group', this)">üë•<br>GRUPO</button>
        <button class="nav-btn" onclick="location.href='chat_privado.html'">üí¨<br>CHAT</button>
    </nav>
</div>

<script>
    const USER = localStorage.getItem('rantiy_user') || "Invitado";
    const ADMIN_USER = "TU_USUARIO_AQU√ç"; // CAMBIA ESTO POR TU NOMBRE
    let currentZone = "HUANTA";

    // --- COORDENADAS ---
    const COORDS = {
        HUANTA: { lat: -12.94, lon: -74.24, r: 30 },
        CUSCO:  { lat: -13.52, lon: -71.96, r: 40 },
        VRAEM:  { lat: -12.50, lon: -73.85, r: 80 }
    };

    function checkAccess() {
        if (USER === ADMIN_USER) {
            document.getElementById('admin-tag').style.display = 'block';
            unlock();
            return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
            let userLat = pos.coords.latitude;
            let userLon = pos.coords.longitude;
            let inside = false;

            for (let z in COORDS) {
                let d = getDistance(userLat, userLon, COORDS[z].lat, COORDS[z].lon);
                if (d <= COORDS[z].r) { inside = true; break; }
            }

            if (inside) unlock();
            else lock("Acceso Denegado", "No est√°s dentro de las zonas del Imperio.");
        }, () => lock("GPS Apagado", "Activa tu ubicaci√≥n para entrar."));
    }

    function unlock() {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('user-display').innerText = USER;
        renderMarket();
    }

    function lock(t, m) {
        document.getElementById('l-title').innerText = t;
        document.getElementById('l-msg').innerText = m;
        document.getElementById('l-btn').style.display = 'block';
    }

    function getDistance(l1, n1, l2, n2) {
        const R = 6371;
        const dLat = (l2-l1) * Math.PI/180;
        const dLon = (n2-n1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function setZone(z, el) {
        currentZone = z;
        document.querySelectorAll('.zone-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        renderMarket();
        renderGroupChat();
    }

    function renderMarket() {
        const feed = document.getElementById('market-feed');
        const posts = JSON.parse(localStorage.getItem('empire_posts') || '[]');
        const filtered = posts.filter(p => p.city === currentZone);

        feed.innerHTML = filtered.map(p => `
            <div class="product-card">
                <div class="img-container">
                    ${(p.u === USER || USER === ADMIN_USER) ? `<button class="delete-btn" onclick="deletePost(${p.id})">‚úï</button>` : ''}
                    <div class="price">S/ ${p.price}</div>
                    <img src="${p.imgs[0] || 'https://via.placeholder.com/300'}">
                </div>
                <div class="product-info">
                    <h3>${p.title}</h3>
                    <button onclick="goPrivate('${p.u}')">NEGOCIAR</button>
                </div>
            </div>
        `).join('');
    }

    function deletePost(id) {
        if(confirm("¬øVendido?")) {
            confetti({ particleCount: 100, spread: 70, colors: ['#22c55e', '#fbbf24'] });
            let posts = JSON.parse(localStorage.getItem('empire_posts') || '[]');
            posts = posts.filter(p => p.id !== id);
            localStorage.setItem('empire_posts', JSON.stringify(posts));
            renderMarket();
        }
    }

    function sendGroupMsg() {
        const input = document.getElementById('g-input');
        if(!input.value.trim()) return;
        let msgs = JSON.parse(localStorage.getItem('chat_group_' + currentZone) || '[]');
        msgs.push({ u: USER, t: input.value });
        localStorage.setItem('chat_group_' + currentZone, JSON.stringify(msgs));
        input.value = "";
        renderGroupChat();
    }

    function renderGroupChat() {
        const box = document.getElementById('group-box');
        let msgs = JSON.parse(localStorage.getItem('chat_group_' + currentZone) || '[]');
        box.innerHTML = msgs.map(m => `
            <div class="g-msg ${m.u === USER ? 'g-msg-me' : 'g-msg-them'}">
                <span class="u">${m.u}</span>
                ${m.t}
            </div>
        `).join('');
        box.scrollTop = box.scrollHeight;
    }

    function switchView(v, el) {
        document.querySelectorAll('.view').forEach(vw => vw.classList.remove('active'));
        document.getElementById('v-' + v).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        if(v === 'group') renderGroupChat();
    }

    function goPrivate(s) {
        localStorage.setItem('current_chat_partner', s);
        location.href = 'chat_privado.html';
    }

    window.onload = checkAccess;
    setInterval(renderGroupChat, 3000); // Sincronizaci√≥n grupo cada 3 seg
</script>
</body>
</html>
