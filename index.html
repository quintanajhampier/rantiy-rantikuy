<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R&R Imperio - Seguridad M√°xima</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --verde: #22c55e; --oro: #facc15; --oscuro: #0f172a; --error: #ff4757; }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: #f4f7f6; margin: 0; }

        /* --- PANTALLA DE BLOQUEO INTELIGENTE --- */
        #master-lock { position: fixed; inset: 0; background: white; z-index: 10000; display: flex; align-items: center; justify-content: center; text-align: center; }
        .lock-content { padding: 40px; max-width: 350px; }
        .radar { width: 80px; height: 80px; border: 4px solid var(--verde); border-radius: 50%; margin: 0 auto 20px; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- VITRINA PREMIUM --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; padding-bottom: 100px; }
        .card { background: white; border-radius: 22px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.02); }
        .img-w { width: 100%; aspect-ratio: 1/1; position: relative; }
        .img-w img { width: 100%; height: 100%; object-fit: cover; }

        /* Bot√≥n de Venta (Due√±o/Admin) */
        .sold-btn { position: absolute; top: 10px; right: 10px; background: var(--error); color: white; border: none; width: 32px; height: 32px; border-radius: 10px; font-weight: 800; cursor: pointer; z-index: 20; box-shadow: 0 4px 10px rgba(255,71,87,0.3); }

        .price-tag { background: var(--verde); color: white; padding: 5px 10px; border-radius: 10px; font-size: 14px; font-weight: 800; position: absolute; bottom: 10px; left: 10px; }
        
        .info { padding: 12px; }
        .info b { display: block; font-size: 13px; color: var(--oscuro); margin-bottom: 8px; height: 2.6em; overflow: hidden; line-height: 1.3; }
        .btn-msg { width: 100%; padding: 12px; background: var(--oscuro); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 11px; }

        /* --- NAVEGACI√ìN --- */
        .nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; background: var(--oscuro); border-radius: 24px; display: flex; justify-content: space-around; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .n-item { color: #64748b; font-size: 10px; text-align: center; font-weight: 800; }
        .active { color: var(--verde); }
    </style>
</head>
<body>

<div id="master-lock">
    <div class="lock-content">
        <div id="radar-ui" class="radar"></div>
        <h2 id="l-title">Escaneando Identidad</h2>
        <p id="l-msg" style="color: #64748b; font-size: 14px;">Iniciando protocolos de seguridad R&R...</p>
        <button id="btn-retry" onclick="checkSecurity()" style="display:none; width:100%; padding:15px; background:var(--verde); color:white; border:none; border-radius:15px; font-weight:800; margin-top:15px;">FORZAR RE-ESCANEO</button>
    </div>
</div>

<header style="padding: 15px; background: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">
    <div style="font-weight: 900; letter-spacing: -1px; font-size: 20px;">R&R <span style="color:var(--verde)">IMPERIO</span></div>
    <div id="badge-admin" style="display:none; background: var(--oro); color: var(--oscuro); font-size: 9px; font-weight: 900; padding: 4px 8px; border-radius: 6px;">MASTER ADMIN</div>
</header>

<div class="grid" id="main-feed"></div>

<nav class="nav">
    <div class="n-item active">üè†<br>VITRINA</div>
    <div class="n-item" onclick="alert('Acceso a Grupos Protegido')">üë•<br>GRUPOS</div>
    <div class="n-item" onclick="location.href='chat_privado.html'">üí¨<br>CHATS</div>
</nav>

<script>
    // --- PROTOCOLO DUE√ëO / ADMIN ---
    const ADMIN_USER = "TU_USUARIO_AQU√ç"; // Pon aqu√≠ tu nombre de usuario exacto del registro
    const currentUser = localStorage.getItem('rantiy_user');

    // COORDENADAS ESTRICTAS (CENTRO Y RADIO AJUSTADO)
    const ZONES = {
        HUANTA: { lat: -12.9400, lon: -74.2400, r: 15 },
        CUSCO:  { lat: -13.5226, lon: -71.9673, r: 25 },
        VRAEM:  { lat: -12.5000, lon: -73.8500, r: 50 }
    };

    function checkSecurity() {
        const title = document.getElementById('l-title');
        const msg = document.getElementById('l-msg');
        const retry = document.getElementById('btn-retry');

        // REGLA 1: EL DUE√ëO TIENE PASE LIBRE
        if (currentUser === ADMIN_USER) {
            document.getElementById('badge-admin').style.display = 'block';
            unlock();
            return;
        }

        // REGLA 2: GPS ESTRICTO PARA OTROS
        if (!navigator.geolocation) {
            msg.innerText = "Error: Hardware GPS no detectado.";
            return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            let access = false;

            for (let z in ZONES) {
                if (getDist(lat, lon, ZONES[z].lat, ZONES[z].lon) <= ZONES[z].r) {
                    access = true;
                    break;
                }
            }

            if (access) unlock();
            else {
                title.innerText = "ZONA RESTRINGIDA";
                msg.innerText = "Te encuentras fuera de los l√≠mites permitidos del Imperio.";
                document.getElementById('radar-ui').style.borderColor = "var(--error)";
                retry.style.display = 'block';
            }
        }, () => {
            title.innerText = "GPS OBLIGATORIO";
            msg.innerText = "Para entrar al mercado debes dar permiso de ubicaci√≥n.";
            retry.style.display = 'block';
        }, { enableHighAccuracy: true });
    }

    function getDist(l1, n1, l2, n2) {
        const R = 6371;
        const dLat = (l2-l1) * Math.PI/180;
        const dLon = (n2-n1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function unlock() {
        document.getElementById('master-lock').style.display = 'none';
        renderFeed();
    }

    function renderFeed() {
        const feed = document.getElementById('main-feed');
        const posts = JSON.parse(localStorage.getItem('empire_posts') || '[]');
        
        feed.innerHTML = posts.map(p => `
            <div class="card">
                <div class="img-w">
                    ${(p.u === currentUser || currentUser === ADMIN_USER) ? `<button class="sold-btn" onclick="sellItem(${p.id})">‚úï</button>` : ''}
                    <div class="price-tag">S/ ${p.price}</div>
                    <img src="${p.imgs[0] || 'https://via.placeholder.com/300'}">
                </div>
                <div class="info">
                    <b>${p.title}</b>
                    <button class="btn-msg" onclick="goChat('${p.u}')">HABLAR CON VENDEDOR</button>
                </div>
            </div>
        `).join('');
    }

    function sellItem(id) {
        if(confirm("¬øConfirmas que el producto se vendi√≥?")) {
            // EFECTO DE SOLES (AMARILLO ORO)
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#facc15', '#fbbf24', '#ffffff'] });

            let posts = JSON.parse(localStorage.getItem('empire_posts') || '[]');
            posts = posts.filter(p => p.id !== id);
            localStorage.setItem('empire_posts', JSON.stringify(posts));
            setTimeout(renderFeed, 1000);
        }
    }

    function goChat(s) {
        localStorage.setItem('current_chat_partner', s);
        location.href = 'chat_privado.html';
    }

    window.onload = checkSecurity;
</script>
</body>
</html>
