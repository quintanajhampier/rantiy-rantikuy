<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rantiy | Sistema Operativo de Comercio Regional</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --r-green: #22c55e;
            --r-green-deep: #15803d;
            --r-gold: #fbbf24;
            --r-dark: #020617;
            --r-card: #0f172a;
            --r-text: #f8fafc;
            --huanta: #10b981;
            --huamanga: #3b82f6;
            --vraem: #f59e0b;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
        }

        /* Reset & Base */
        * { 
            box-sizing: border-box; 
            margin: 0; padding: 0; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body { 
            background: var(--r-dark); 
            color: var(--r-text); 
            overflow-x: hidden;
            min-height: 100vh;
        }

        #canvas-bg { position: fixed; top: 0; left: 0; z-index: -1; }

        /* Estructura SPA */
        .app-wrapper {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        /* Header Imperial */
        header {
            padding: 25px;
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-r {
            width: 45px; height: 45px;
            background: linear-gradient(135deg, var(--r-green), var(--r-green-deep));
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 22px;
            box-shadow: 0 0 25px rgba(34, 197, 94, 0.4);
        }

        /* Selector de Ciudades */
        .city-nav {
            padding: 20px;
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .city-nav::-webkit-scrollbar { display: none; }
        
        .city-pill {
            padding: 14px 24px;
            border-radius: 30px;
            background: var(--glass);
            border: 1px solid var(--border);
            color: rgba(255,255,255,0.6);
            white-space: nowrap;
            cursor: pointer;
            font-weight: 700;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .city-pill.active {
            background: white;
            color: var(--r-dark);
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* Rantikuy Feed */
        .feed-container { padding: 0 20px 120px 20px; flex: 1; }
        .product-card {
            background: var(--r-card);
            border-radius: 40px;
            margin-bottom: 25px;
            overflow: hidden;
            border: 1px solid var(--border);
            position: relative;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .img-carousel {
            height: 350px;
            display: flex;
            overflow-x: auto;
            snap-type: x mandatory;
            scrollbar-width: none;
        }
        .img-carousel::-webkit-scrollbar { display: none; }
        .img-carousel img {
            min-width: 100%;
            height: 100%;
            object-fit: cover;
            snap-align: start;
        }

        .sticker {
            position: absolute; top: 20px; left: 20px;
            padding: 8px 16px; border-radius: 12px;
            font-weight: 800; font-size: 11px; color: white;
            z-index: 5; text-transform: uppercase;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        .s-oferta { background: #ef4444; }
        .s-premium { background: var(--r-gold); color: black; }
        .s-nuevo { background: var(--huamanga); }

        .card-details { padding: 25px; }
        .price { font-size: 30px; font-weight: 800; color: var(--r-green); margin-bottom: 8px; }
        .title { font-size: 20px; font-weight: 700; margin-bottom: 15px; }

        /* Rantikuy Studio (Editor) */
        .studio-modal {
            background: var(--r-card);
            padding: 30px;
            border-radius: 45px 45px 0 0;
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            z-index: 2000;
            transform: translateY(100%);
            transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            border: 1px solid var(--border);
        }
        .studio-modal.open { transform: translateY(0); }

        .input-imperial {
            width: 100%; padding: 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: white; font-weight: 600;
            margin-bottom: 15px;
        }
        .input-imperial:focus { border-color: var(--r-green); }

        .btn-publish {
            width: 100%; padding: 22px;
            background: var(--r-green);
            color: white; border: none;
            border-radius: 22px; font-weight: 800;
            font-size: 18px; cursor: pointer;
            box-shadow: 0 15px 30px rgba(34, 197, 94, 0.3);
        }

        /* Nav Island */
        .nav-island {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 450px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(25px);
            padding: 15px; border-radius: 40px;
            display: flex; justify-content: space-around;
            border: 1px solid var(--border);
            z-index: 1500;
        }
        .nav-node {
            display: flex; flex-direction: column; align-items: center;
            color: rgba(255,255,255,0.4); cursor: pointer;
            transition: 0.3s;
        }
        .nav-node.active { color: var(--r-green); }
        .nav-node span { font-size: 22px; margin-bottom: 5px; }
        .nav-node label { font-size: 10px; font-weight: 800; }

        /* Chat System */
        .chat-view { height: calc(100vh - 200px); display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .bubble {
            padding: 16px 20px; border-radius: 24px; max-width: 80%;
            font-size: 15px; line-height: 1.4;
        }
        .me { background: var(--r-green); align-self: flex-end; color: white; border-bottom-right-radius: 4px; }
        .them { background: var(--glass); align-self: flex-start; border-bottom-left-radius: 4px; }

        /* Helpers */
        .hidden { display: none !important; }
        .blur { filter: blur(10px); pointer-events: none; }
    </style>
</head>
<body onload="bootApp()">

    <canvas id="canvas-bg"></canvas>

    <div class="app-wrapper" id="main-content">
        <header>
            <div class="logo-container">
                <div class="logo-r">R</div>
                <div>
                    <h1 style="font-size: 20px; font-weight: 800; letter-spacing: -0.5px;">Rantiy Imperio</h1>
                    <div id="gps-status" style="font-size: 9px; color: var(--r-green); font-weight: 800;">VERIFICANDO GPS...</div>
                </div>
            </div>
            <div id="imperial-clock" style="font-weight: 800; font-size: 12px; opacity: 0.6;">00:00</div>
        </header>

        <nav class="city-nav">
            <div class="city-pill active" onclick="changeCity('Huanta', this)">‚õ∞Ô∏è Huanta</div>
            <div class="city-pill" onclick="changeCity('Huamanga', this)">‚õ™ Huamanga</div>
            <div class="city-pill" onclick="changeCity('VRAEM', this)">üåø VRAEM</div>
        </nav>

        <main id="view-home" class="feed-container"></main>
        
        <main id="view-chat" class="feed-container hidden">
            <div class="chat-view">
                <div id="chat-box" class="chat-messages"></div>
                <div style="padding: 15px; display: flex; gap: 10px;">
                    <input type="text" id="msg-input" class="input-imperial" style="margin: 0;" placeholder="Escribe al Imperio...">
                    <button onclick="sendChatMessage()" style="background: var(--r-green); width: 60px; height: 60px; border-radius: 18px; border: none; color: white;">‚úàÔ∏è</button>
                </div>
            </div>
        </main>

        <nav class="nav-island">
            <div class="nav-node active" onclick="navigate('home', this)"><span>üè†</span><label>VITRINA</label></div>
            <div class="nav-node" onclick="toggleStudio()"><span>üì∏</span><label>STUDIO</label></div>
            <div class="nav-node" onclick="navigate('chat', this)"><span>üí¨</span><label>CHATS</label></div>
        </nav>
    </div>

    <div class="studio-modal" id="studio-ui">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h2 style="font-weight: 800;">Rantikuy Studio</h2>
            <button onclick="toggleStudio()" style="background:none; border:none; color:white; font-size:24px;">‚úï</button>
        </div>

        <div id="media-preview" style="display:flex; gap:10px; margin-bottom:20px; overflow-x:auto;">
            <div onclick="document.getElementById('file-in').click()" style="min-width:100px; height:100px; background:rgba(255,255,255,0.05); border-radius:20px; display:flex; align-items:center; justify-content:center; border:2px dashed var(--border); cursor:pointer;">
                <span>‚ûï</span>
            </div>
        </div>
        <input type="file" id="file-in" class="hidden" multiple accept="image/*" onchange="handleFiles(this)">

        <input type="text" id="p-title" class="input-imperial" placeholder="¬øQu√© quieres vender/ofrecer?">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="number" id="p-price" class="input-imperial" placeholder="Precio S/">
            <select id="p-sticker" class="input-imperial">
                <option value="s-nuevo">NUEVO</option>
                <option value="s-oferta">OFERTA</option>
                <option value="s-premium">PREMIUM</option>
            </select>
        </div>

        <button class="btn-publish" onclick="publishProduct()">PUBLICAR AHORA üöÄ</button>
    </div>

    <script>
        // --- MOTOR DE DATOS ---
        let appState = {
            currentCity: 'Huanta',
            products: [],
            chats: [],
            lastReset: Date.now()
        };

        let tempImages = [];

        // --- INICIALIZACI√ìN ---
        function bootApp() {
            init3D();
            loadData();
            updateClock();
            setInterval(updateClock, 60000);
            renderFeed();
            checkGPS();
        }

        function loadData() {
            const saved = localStorage.getItem('rantiy_pro_data');
            if (saved) {
                appState = JSON.parse(saved);
                // L√≥gica de 30 horas para limpieza de chat
                if (Date.now() - appState.lastReset > 30 * 60 * 60 * 1000) {
                    appState.chats = [];
                    appState.lastReset = Date.now();
                    saveData();
                }
            }
        }

        function saveData() {
            localStorage.setItem('rantiy_pro_data', JSON.stringify(appState));
        }

        // --- SISTEMA 3D ---
        function init3D() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas-bg'), antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            const geometry = new THREE.TorusKnotGeometry(10, 3, 100, 16);
            const material = new THREE.MeshBasicMaterial({ color: 0x22c55e, wireframe: true, transparent: true, opacity: 0.05 });
            const knot = new THREE.Mesh(geometry, material);
            scene.add(knot);

            camera.position.z = 30;

            function animate() {
                requestAnimationFrame(animate);
                knot.rotation.y += 0.005;
                knot.rotation.x += 0.002;
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            });
        }

        // --- L√ìGICA DE NAVEGACI√ìN ---
        function navigate(view, el) {
            document.querySelectorAll('main').forEach(m => m.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            document.querySelectorAll('.nav-node').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            if(view === 'home') renderFeed();
            if(view === 'chat') renderChats();
        }

        function toggleStudio() {
            const modal = document.getElementById('studio-ui');
            const wrapper = document.getElementById('main-content');
            modal.classList.toggle('open');
            wrapper.classList.toggle('blur');
        }

        function changeCity(city, el) {
            appState.currentCity = city;
            document.querySelectorAll('.city-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            renderFeed();
            renderChats();
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#22c55e', '#fbbf24'] });
        }

        // --- RANTIKUY STUDIO LOGIC ---
        function handleFiles(input) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    tempImages.push(e.target.result);
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = "width:100px; height:100px; object-fit:cover; border-radius:20px;";
                    document.getElementById('media-preview').appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        function publishProduct() {
            const title = document.getElementById('p-title').value;
            const price = document.getElementById('p-price').value;
            const sticker = document.getElementById('p-sticker').value;

            if (!title || !price || tempImages.length === 0) {
                alert("Imperio: Faltan datos o im√°genes.");
                return;
            }

            const product = {
                id: Date.now(),
                title, price, sticker,
                imgs: [...tempImages],
                city: appState.currentCity,
                user: "Emperador"
            };

            appState.products.unshift(product);
            saveData();
            
            // Reset
            tempImages = [];
            document.getElementById('p-title').value = "";
            document.getElementById('p-price').value = "";
            document.getElementById('media-preview').innerHTML = `<div onclick="document.getElementById('file-in').click()" style="min-width:100px; height:100px; background:rgba(255,255,255,0.05); border-radius:20px; display:flex; align-items:center; justify-content:center; border:2px dashed var(--border); cursor:pointer;"><span>‚ûï</span></div>`;
            
            toggleStudio();
            renderFeed();
        }

        function renderFeed() {
            const container = document.getElementById('view-home');
            const filtered = appState.products.filter(p => p.city === appState.currentCity);
            
            if(filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:100px 0; opacity:0.3;"><h2>No hay ofertas en ${appState.currentCity}</h2></div>`;
                return;
            }

            container.innerHTML = filtered.map(p => `
                <div class="product-card">
                    <div class="sticker ${p.sticker}">${p.sticker.split('-')[1]}</div>
                    <div class="img-carousel">
                        ${p.imgs.map(img => `<img src="${img}">`).join('')}
                    </div>
                    <div class="card-details">
                        <div class="price">S/ ${p.price}</div>
                        <div class="title">${p.title}</div>
                        <button onclick="startChatWith('${p.title}')" style="width:100%; padding:15px; border-radius:15px; border:none; background:white; color:black; font-weight:800;">NEGOCIAR</button>
                    </div>
                </div>
            `).join('');
        }

        // --- CHAT LOGIC ---
        function sendChatMessage() {
            const input = document.getElementById('msg-input');
            if(!input.value) return;

            appState.chats.push({
                text: input.value,
                city: appState.currentCity,
                me: true,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });

            input.value = "";
            saveData();
            renderChats();
        }

        function renderChats() {
            const box = document.getElementById('chat-box');
            const msgs = appState.chats.filter(c => c.city === appState.currentCity);
            box.innerHTML = msgs.map(m => `
                <div class="bubble ${m.me ? 'me' : 'them'}">
                    ${m.text}
                    <div style="font-size:9px; opacity:0.5; margin-top:5px; text-align:right;">${m.time}</div>
                </div>
            `).join('');
            box.scrollTop = box.scrollHeight;
        }

        function startChatWith(name) {
            navigate('chat', document.querySelectorAll('.nav-node')[2]);
            appState.chats.push({ text: `¬°Hola! Me interesa: ${name}`, city: appState.currentCity, me: true, time: "Ahora" });
            renderChats();
        }

        // --- UTILS ---
        function updateClock() {
            const now = new Date();
            document.getElementById('imperial-clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function checkGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(() => {
                    document.getElementById('gps-status').innerText = "üìç GPS ACTIVADO (ZONA SEGURA)";
                }, () => {
                    document.getElementById('gps-status').innerText = "‚ö†Ô∏è GPS DESACTIVADO";
                    document.getElementById('gps-status').style.color = "#ef4444";
                });
            }
        }
    </script>
</body>
</html>
